<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.15">
<meta name="author" content="Dominic Heutelbeck">
<title>SAPL - Streaming Attribute Policy Language</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SAPL - Streaming Attribute Policy Language</h1>
<div class="details">
<span id="author" class="author">Dominic Heutelbeck</span><br>
<span id="revdate">Version 2.0.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#authorization-subscriptions">Authorization Subscriptions</a></li>
<li><a href="#structure-of-a-sapl-policy">Structure of a SAPL Policy</a></li>
<li><a href="#authorization-decisions">Authorization Decisions</a></li>
<li><a href="#accessing-attributes">Accessing Attributes</a></li>
<li><a href="#getting-started">Getting Started</a></li>
</ul>
</li>
<li><a href="#reference-architecture">Reference Architecture</a>
<ul class="sectlevel2">
<li><a href="#policy-enforcement-point-pep">Policy Enforcement Point (PEP)</a></li>
<li><a href="#policy-decision-point-pdp">Policy Decision Point (PDP)</a></li>
<li><a href="#policy-administration-point-pap">Policy Administration Point (PAP)</a></li>
</ul>
</li>
<li><a href="#publish-subscribe-protocol">Publish / Subscribe Protocol</a>
<ul class="sectlevel2">
<li><a href="#sapl-authorization-subscription">SAPL Authorization Subscription</a></li>
<li><a href="#sapl-authorization-decision">SAPL Authorization Decision</a></li>
<li><a href="#policy-evaluation">Policy Evaluation</a></li>
<li><a href="#multi-subscriptions">Multi-Subscriptions</a></li>
</ul>
</li>
<li><a href="#pdp-apis">PDP APIs</a>
<ul class="sectlevel2">
<li><a href="#http-server-sent-events-api">HTTP Server-Sent Events API</a></li>
<li><a href="#java-api">Java API</a></li>
</ul>
</li>
<li><a href="#the-sapl-policy-language">The SAPL Policy Language</a>
<ul class="sectlevel2">
<li><a href="#overview">Overview</a></li>
<li><a href="#imports">Imports</a></li>
<li><a href="#sapl-policy">SAPL Policy</a></li>
<li><a href="#sapl-policy-set">SAPL Policy Set</a></li>
<li><a href="#language-elements">Language Elements</a></li>
<li><a href="#sapl-expressions">SAPL Expressions</a></li>
</ul>
</li>
<li><a href="#authorization-subscription-evaluation">Authorization Subscription Evaluation</a>
<ul class="sectlevel2">
<li><a href="#policy-2">Policy</a></li>
<li><a href="#policy-set">Policy Set</a></li>
<li><a href="#authorization-subscription">Authorization Subscription</a></li>
<li><a href="#combining-algorithm-2">Combining Algorithm</a></li>
<li><a href="#transformation-2">Transformation</a></li>
<li><a href="#obligation-advice">Obligation / Advice</a></li>
</ul>
</li>
<li><a href="#functions">Functions</a>
<ul class="sectlevel2">
<li><a href="#custom-function-libraries">Custom Function Libraries</a></li>
</ul>
</li>
<li><a href="#attribute-finders">Attribute Finders</a>
<ul class="sectlevel2">
<li><a href="#custom-attribute-finders">Custom Attribute Finders</a></li>
</ul>
</li>
<li><a href="#testing-sapl-policies">Testing SAPL policies</a>
<ul class="sectlevel2">
<li><a href="#usage-scenarios">Usage scenarios</a></li>
<li><a href="#unit-tests">Unit-Tests</a></li>
<li><a href="#policy-integration-tests">Policy-Integration-Tests</a></li>
<li><a href="#writing-test-cases">Writing test cases</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#code-coverage-reports-via-the-sapl-maven-plugin">Code-Coverage Reports via the SAPL-Maven-Plugin</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SAPL (Streaming Attribute Policy Language) describes a <strong>domain-specific language (DSL)</strong> for expressing access control policies and a <strong>publish/subscribe protocol</strong> based on <a href="http://json.org/">JSON</a>.
Policies expressed in SAPL describe conditions for access control in applications and distributed systems. The underlying policy engine implements a variant of Attribute-based Access control (ABAC) which enables processing of data streams and follows reactive programming patterns. Namely, the SAPL policy engine implements Attribute Stream-based Access Control (ASBAC).</p>
</div>
<div class="paragraph">
<p>A typical scenario for the application of SAPL would be a subject (e.g., a user or system) attempting to take action (e.g., read or cancel an order) on a protected resource (e.g., a domain object of an application or a file). The subject makes a subscription request to the system (e.g., an application) to execute the action with the resource. The system implements a <strong>policy enforcement point (PEP)</strong> protecting its resources. The PEP collects information about the subject, action, resource, and potential other relevant data in an authorization subscription request and sends it to a policy decision point (PDP) that checks SAPL policies to decide if it grants access to the resource. This decision is packed in an authorization decision object and sent back to the PEP, which either grants access or denies access to the resource depending on the decision. The PDP subscribes to all data sources for the decision, and new decisions are sent to the PEP whenever indicated by the policies and data sources.</p>
</div>
<div class="paragraph">
<p>There exist several proprietary platforms dependent or standardized languages, such as <a href="http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html">XACML</a>, for expressing policies. SAPL brings several advantages over these solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Universality</strong>. SAPL offers a standard, generic, platform-independent language for expressing policies.</p>
</li>
<li>
<p><strong>Separation of Concerns</strong>. Applying SAPL to a domain model is relieved from modeling many aspects of access control. SAPL favors configuration at runtime over implementation and re-deployment of applications.</p>
</li>
<li>
<p><strong>Modularity and Distribution</strong>. SAPL allows managing policies in a modular fashion allowing the distribution of authoring responsibilities across teams.</p>
</li>
<li>
<p><strong>Expressiveness</strong>. SAPL provides access control schemata beyond the capabilities of most other practical languages. It allows for attribute-based access control (ABAC), role-based access control (RBAC), forms of entity-based access control (EBAC), and parameterized attribute access and attribute streaming.</p>
</li>
<li>
<p><strong>Human Readability</strong>. The SAPL syntax is designed from the ground up to be easily readable by humans. Basic SAPL is easy to pick up for getting started but offers enough expressiveness to address complex access control scenarios.</p>
</li>
<li>
<p><strong>Transformation and Filtering</strong>. SAPL allows transforming resources and filtering data from resources (e.g., blacken the first digits of a credit card number or hiding birth dates by assigning individuals into age groups).</p>
</li>
<li>
<p>SAPL supports <strong>session and data stream-based applications</strong> and offers low-latency authorization for interactive applications and data streams.</p>
</li>
<li>
<p>SAPL supports <strong>JSON-driven APIs</strong> and integrates easily with modern JSON-based APIs. The core data model of SAPL is JSON offering straightforward reasoning over such data and simple access to external attributes from RESTful JSON APIs.</p>
</li>
<li>
<p>SAPL supports <strong>Multi-Subscriptions</strong>. SAPL allows bundling multiple authorization subscriptions into one multi-subscription, thus further reducing connection time and latency.
The following sections will explain the basic concepts of SAPL policies and show how to integrate SAPL into a Java application easily. Afterward, this document explains the different parts of SAPL in more detail.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="authorization-subscriptions"><a class="anchor" href="#authorization-subscriptions"></a>Authorization Subscriptions</h3>
<div class="paragraph">
<p>A SAPL authorization subscription is a JSON object, i.e., a set of name/value pairs or <em>attributes</em>. It contains attributes with the names <code>subject</code>, <code>action</code>, <code>resource</code>, and <code>environment</code>. The values of these attributes may be any arbitrary JSON value, e.g.:</p>
</div>
<div class="listingblock">
<div class="title">Introduction - Sample Authorization Subscription</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "subject"     : {
                    "username"    : "alice",
                    "tracking_id" : 1234321,
                    "nda_signed"  : true
                  },
  "action"      : "HTTP:GET",
  "resource"    : "https://medical.org/api/patients/123",
  "environment" : null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This authorization subscription expresses the intent of the user <code>alice</code>, with the given attributes, to <code>HTTP:GET</code> the resource at <code>https://medical.org/api/patients/123</code>. This SAPL authorization subscription can be used in a RESTful API, implementing a PEP protecting the API&#8217;s request handlers.</p>
</div>
</div>
<div class="sect2">
<h3 id="structure-of-a-sapl-policy"><a class="anchor" href="#structure-of-a-sapl-policy"></a>Structure of a SAPL Policy</h3>
<div class="paragraph">
<p>A SAPL policy document generally consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the keyword <code>policy</code>, declaring that the document contains a policy (opposed to a policy set; more on policy sets <a href="#policy-set">see below</a>)</p>
</li>
<li>
<p>a unique (for the PDP) policy name</p>
</li>
<li>
<p>the entitlement, which is the decision result to be returned upon successful evaluation of the policy, i.e., <code>permit</code> or <code>deny</code></p>
</li>
<li>
<p>an optional target expression for indexing and policy selection</p>
</li>
<li>
<p>an optional <code>where</code> clause containing the conditions under which the entitlement (<code>permit</code> or <code>deny</code> as defined above) applies</p>
</li>
<li>
<p>optional <code>advice</code> and <code>obligation</code> clauses to inform the PEP about optional and mandatory requirements for granting access to the resource</p>
</li>
<li>
<p>an optional <code>transformation</code> clause for defining a transformed resource to be used instead of the original resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A simple SAPL policy that allows <code>alice</code> to <code>HTTP:GET</code> the resource <code>https://medical.org/api/patients/123</code> would look as follows (in a real-world scenario, this policy is too specific):</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Policy 1</div>
<div class="content">
<pre class="highlight"><code class="language-asciidoc" data-lang="asciidoc">policy "permit_alice_get_patient123" <i class="conum" data-value="1"></i><b>(1)</b>
permit resource =~ "^https://medical.org/api/patients.*" <i class="conum" data-value="2"></i><b>(2)</b>
where <i class="conum" data-value="3"></i><b>(3)</b>
  subject.username == "alice"; <i class="conum" data-value="4"></i><b>(4)</b>
  action == "HTTP:GET";
  resource == "https://medical.org/api/patients/123";</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This statement declares the policy with the name <code>permit_alice_get_patient123</code>. The JSON values of the authorization subscription object are bound to the variables <code>subject</code>, <code>action</code>, <code>resource</code>, and <code>environment</code> that are directly accessible in the policy. The syntax <code>.name</code> accesses attributes of a nested JSON object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This statement declares that if the resource is a string starting with <code><a href="https://medical.org/api/patients" class="bare">https://medical.org/api/patients</a></code> (using the regular expression operator <code>=~</code>) and the conditions of the <code>where</code> clause applies, the subject will be granted access to the resource. Note that the <code>where</code> clause is only evaluated if the condition of the target expression evaluates to <code>true</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This statement starts the <code>where</code> clause (policy body) consisting of a list of statements. The policy body evaluates to <code>true</code> if all statements evaluate to <code>true</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="authorization-decisions"><a class="anchor" href="#authorization-decisions"></a>Authorization Decisions</h3>
<div class="paragraph">
<p>The SAPL authorization decision to the authorization subscription is a JSON object as well. It contains the attribute <code>decision</code> as well as the optional attributes <code>resource</code>, <code>obligation</code>, and <code>advice</code>. For the introductory sample authorization subscription with the preceding policy, a SAPL authorization decision would look as follows:</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Authorization Decision</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "decision"   : "PERMIT"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The PEP evaluates this authorization decision and grants or denies access accordingly.</p>
</div>
</div>
<div class="sect2">
<h3 id="accessing-attributes"><a class="anchor" href="#accessing-attributes"></a>Accessing Attributes</h3>
<div class="paragraph">
<p>In many use cases, the authorization subscription contains all the required information for making a decision. However, the PEP is usually not aware of the specifics of the access policies and may not have access to all information required for making the decision. In this case, the PDP can access external attributes. The following example shows how SAPL expresses access to attributes.</p>
</div>
<div class="paragraph">
<p>Extending the example above, in a real-world application, there will be multiple patients and multiple users. Thus, policies need to be worded more abstractly. In a natural language, a suitable policy could be <em>Permit doctors to <code>HTTP:GET</code> data from any patient</em>. The policy addresses the profile attribute of the subject, stored externally. SAPL allows to express this policy as follows:</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Policy 2</div>
<div class="content">
<pre class="highlight"><code class="language-asciidoc" data-lang="asciidoc">policy "doctors_get_patient"
permit
  action == "HTTP:GET" &amp;
  resource =~ "^https://medical\.org/api/patients/\d*$"
where
  subject.username.&lt;user.profile&gt;.function == "doctor";</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <em>line 4</em> a regular expression is used for identifying a request to any patient&#8217;s data (operator <code>=~</code>). The authorization subscription resource must match this pattern for the policy to apply.</p>
</div>
<div class="paragraph">
<p>The policy assumes that the user&#8217;s function is not provided in the authorization subscription but stored in the user&#8217;s profile. Accordingly,  <em>line 6</em> accesses the attribute <code>user.profile</code> (using an attribute finder step <code>.&lt;finder.name&gt;</code>) to retrieve the profile of the user with the username provided in <code>subject.username</code>. The fetched profile is a JSON object with a property named <code>function</code>. The expression compares it to  <code>"doctor"</code>.</p>
</div>
<div class="paragraph">
<p><em>Line 6</em> is placed in the policy body (starting with <code>where</code>) instead of the target expression. The reason for this location is that the target expression block is also used for indexing policies efficiently and therefore needs to be evaluated quickly. Hence it is not allowed to include conditions that may need to call an external service.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="getting-started"><a class="anchor" href="#getting-started"></a>Getting Started</h3>
<div class="paragraph">
<p>To learn the SAPL policy language and check out some example policies, the <a href="https://playground.sapl.io/">SAPL-Playground</a> offers a tool for safe experimentation.</p>
</div>
<div class="paragraph">
<p>In addition, SAPL provides an embedded PDP, including an embedded PRP with a file system policy store that seamlessly integrates into Java applications. Besides this guide, the quickest way to start is to build upon the demo projects hosted on <a href="https://github.com/heutelbeck/sapl-demos">GitHub</a>. Some good demos to start with are the simple no-framework <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-embedded">Embedded PDP Demo</a> or the full-stack <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-mvc-app">Spring MVC Project</a> or the <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-webflux">Fully reactive Webflux Application</a>.</p>
</div>
<div class="sect3">
<h4 id="maven-dependencies"><a class="anchor" href="#maven-dependencies"></a>Maven Dependencies</h4>
<div class="ulist">
<ul>
<li>
<p>SAPL requires Java 11 or newer and is compatible with Java 17.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;properties&gt;
      &lt;java.version&gt;11&lt;/java.version&gt;
      &lt;maven.compiler.source&gt;${java.version}&lt;/maven.compiler.source&gt;
      &lt;maven.compiler.target&gt;${java.version}&lt;/maven.compiler.target&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a SAPL dependency to the application. When using Maven one can add the following dependencies to the project&#8217;s <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-pdp-embedded&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the Maven Central snapshot repository to the <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;ossrh&lt;/id&gt;
            &lt;url&gt;https://s01.oss.sonatype.org/content/repositories/snapshots&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If more SAPL dependencies are expected to be used, a useful bill of materials POM is offered, centralizing the dependency management for SAPL artifacts:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;io.sapl&lt;/groupId&gt;
            &lt;artifactId&gt;sapl-bom&lt;/artifactId&gt;
            &lt;version&gt;2.0.1&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coding"><a class="anchor" href="#coding"></a>Coding</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the application, create a new <code>EmbeddedPolicyDecisionPoint</code>. The argument <code>"~/sapl"</code> specifies the directory that contains the configuration file <code>pdp.json</code> and all policies (i.e., files ending with <code>.sapl</code>).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">EmbeddedPolicyDecisionPoint pdp = PolicyDecisionPointFactory.filesystemPolicyDecisionPoint("~/sapl");</code></pre>
</div>
</div>
</li>
<li>
<p>Add a <code>pdp.json</code> with the following content to the directory "~/sapl":</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">{
    "algorithm": "DENY_UNLESS_PERMIT",
    "variables": {}
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add some policy sets or policies to <code>"~/sapl"</code>. Both policy sets and policies are files with the extension <code>.sapl</code>. For example, add the following policy:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>policy "test_policy"
permit subject == "admin"</code></pre>
</div>
</div>
</li>
<li>
<p>Obtain a decision using the PDP&#8217;s <code>decide</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">var subscription = AuthorizationSubscription.of("admin", "an_action", "a_resource");
Flux&lt;AuthorizationDecision&gt; authzDecisions = pdp.decide(authzSubscription);
authzDecisions.subscribe(authzDecision -&gt; System.out.println(authzDecision.getDecision()));</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The console output should be <code>PERMIT</code>. With subject set to <code>"alice"</code> instead of <code>"admin"</code>, the output should be <code>DENY</code>.</p>
</div>
<div class="paragraph">
<p>Note at runtime the policies can be modified. Adding or removing polices can immediately trigger a change in the decisions.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference-architecture"><a class="anchor" href="#reference-architecture"></a>Reference Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The architecture of the SAPL policy engine is follows the terminology defined by <a href="https://tools.ietf.org/html/rfc2904">RFC2904 "AAA Authorization Framework"</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/SAPL_Architecture.svg" alt="SAPL Architecture">
</div>
</div>
<div class="sect2">
<h3 id="policy-enforcement-point-pep"><a class="anchor" href="#policy-enforcement-point-pep"></a>Policy Enforcement Point (PEP)</h3>
<div class="paragraph">
<p>The PEP is a software entity that intercepts actions taken by users within an application. Its task is to obtain a decision on whether the requested action should be allowed and accordingly either let the application process the action or deny access. For this purpose, the PEP includes data describing the subscription context (like the subject, the resource, the action, and other environment information) in an authorization subscription object which the PEP hands over to a PDP. The PEP subsequently receives an authorization decision object containing a decision and optionally a resource, obligations, and advice.</p>
</div>
<div class="paragraph">
<p>The PEP must let the application process the action if the decision is <code>PERMIT</code>. If the authorization decision object also contains an <code>obligation</code>, the PEP must fulfill this obligation. Proper fulfillment is an additional requirement for granting access. If the decision is not <code>PERMIT</code> or the obligation cannot be fulfilled, the PEP must deny access. Policies may contain instructions to alter the resource (like blackening certain information, e.g., credit card numbers). If present, the PEP should ensure that the application only reveals the resource contained in the authorization decision object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A PEP strongly depends on the application domain. SAPL comes with a default PEP implementation using a passed in constraint handler service to handle obligations and advice contained in an authorization decision. Developers should integrate PEPs with the platforms and frameworks they are using. SAPL ships with a set of modules for deep integration with Spring Security and Spring Boot.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="policy-decision-point-pdp"><a class="anchor" href="#policy-decision-point-pdp"></a>Policy Decision Point (PDP)</h3>
<div class="paragraph">
<p>The PDP must make an authorization decision based on an authorization subscription object and the access policies it receives from a <strong>Policy Retrieval Point (PRP)</strong> connected to a policy store. Beginning with the authorization subscription object, the PDP fetches policy sets and policies matching the authorization subscription, evaluates them, and combines the results to create and return an authorization decision object. There may be multiple matching policies that might evaluate to different results. To resolve these conflicts, the administrator or developer using a PDP must select a <strong>combining algorithm</strong> (e.g., <code>permit-overrides</code> stating that the decision will be <code>permit</code> if any applicable policy evaluates to <code>permit</code>).</p>
</div>
<div class="paragraph">
<p>A policy may refer to attributes not included in the authorization subscription object. It will have to obtain them from an external <strong>Policy Information Point (PIP)</strong>. The PDP fetches those attributes while evaluating the policy. To be able to access external PIPs, developers can extend the PDP by adding custom attribute finders. Policies might also contain functions not included in the default SAPL implementation. Developers may add custom functions by implementing <strong>Function Libraries</strong>.</p>
</div>
<div class="paragraph">
<p>SAPL provides two simple PDP implementations: An <strong>embedded PDP</strong> with an embedded PRP which can be integrated easily into a Java application, and a <strong>remote PDP client</strong> that obtains decisions through a RESTful interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="policy-administration-point-pap"><a class="anchor" href="#policy-administration-point-pap"></a>Policy Administration Point (PAP)</h3>
<div class="paragraph">
<p>The PAP is an entity that allows managing policies contained in the policy store. In the embedded PDP with the Resources PRP, the policy store can be a simple folder within the local file system containing <code>.sapl</code> files. Therefore, any access to files in this folder (e.g., FTP or SSH) can be seen as a straightforward PAP. The PAP may be a separate application or can be included in an existing administration panel.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="publish-subscribe-protocol"><a class="anchor" href="#publish-subscribe-protocol"></a>Publish / Subscribe Protocol</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The PDP receives an authorization subscription from a PEP and sends an authorization decision. Both subscription and decision are JSON objects consisting of name/value pairs (also called attributes) with predefined names. A PEP must be able to create an authorization subscription and process an authorization decision object.</p>
</div>
<div class="sect2">
<h3 id="sapl-authorization-subscription"><a class="anchor" href="#sapl-authorization-subscription"></a>SAPL Authorization Subscription</h3>
<div class="paragraph">
<p>A SAPL authorization subscription contains attributes with the names <code>subject</code>, <code>resource</code>, <code>action</code>, and <code>environment</code>. Each attribute value can be any JSON value (i.e., an object, an array, a number, a string, <code>true</code>, <code>false</code>, or <code>null</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sapl-authorization-decision"><a class="anchor" href="#sapl-authorization-decision"></a>SAPL Authorization Decision</h3>
<div class="paragraph">
<p>The SAPL authorization decision contains the attributes <code>decision</code>, <code>resource</code>, <code>obligation</code>, and <code>advice</code>.</p>
</div>
<div class="sect3">
<h4 id="decision"><a class="anchor" href="#decision"></a>Decision</h4>
<div class="paragraph">
<p>The <code>decision</code> tells the PEP whether to grant or deny access. Access should be granted only if the decision is <code>"PERMIT"</code>. The <code>decision</code> attribute can be one of the following string values with the described meanings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>"PERMIT"</code>: Access must be granted.</p>
</li>
<li>
<p><code>"DENY"</code>: Access must be denied.</p>
</li>
<li>
<p><code>"NOT_APPLICABLE"</code>: A decision could not be made because no policy is applicable to the authorization subscription. The PEP should deny access in this case.</p>
</li>
<li>
<p><code>"INDETERMINATE"</code>: A decision could not be made because an error occurred. The PEP should deny access in this case.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="resource"><a class="anchor" href="#resource"></a>Resource</h4>
<div class="paragraph">
<p>The PEP knows for which resource it requested access. Thus, there usually is no need to return this resource in the authorization decision object. However, SAPL policies may contain a <code>transform</code> statement describing how the resource needs to be altered before it is returned to the subject seeking permission. This can be used to remove or blacken certain parts of the resource document (e.g., a policy could allow doctors to view patient data but remove any bank account details as they can only be accessed by the accounting department). If a policy that evaluates to <code>PERMIT</code> contains a <code>transform</code> statement, the authorization decision attribute <code>resource</code> contains the transformed resource. Otherwise, there will not be a <code>resource</code> attribute in the authorization decision object.</p>
</div>
</div>
<div class="sect3">
<h4 id="obligation"><a class="anchor" href="#obligation"></a>Obligation</h4>
<div class="paragraph">
<p>The value of <code>obligation</code> contains assignments that the PEP must fulfill before granting or denying access. As there can be multiple policies applicable to the authorization subscription with different obligations, the <code>obligation</code> value in the authorization decision object is an array containing a list of tasks. If the PEP is not able to fulfill these tasks, access must not be granted. The array items can be any JSON value (e.g., a string or an object). Consequently, the PEP must know how to identify and process the obligations contained in the policies. An <code>obligation</code> attribute is only included in the authorization decision object if there is at least one obligation.</p>
</div>
<div class="paragraph">
<p>An authorization decision could, for example, contain the obligation to create a log entry.</p>
</div>
<div class="paragraph">
<p>In case the obligation is contained in a <code>DENY</code> decision, the access must still be denied. An obligation in a <code>DENY</code> decision acts like <code>advice</code> because the unsuccessful handling of the obligation cannot change the overall decision outcome.</p>
</div>
</div>
<div class="sect3">
<h4 id="advice"><a class="anchor" href="#advice"></a>Advice</h4>
<div class="paragraph">
<p>The value of <code>advice</code> is an array with assignments for the PEP as well and works similar to obligations with one difference: The fulfillment of the tasks is no requirement for granting access. I.e., in case the <code>decision</code> is <code>PERMIT</code>, the PEP should also grant access if it can not fulfill the tasks contained in <code>advice</code>. An <code>advice</code> attribute is only included in the authorization decision object if there is at least one element within the <code>advice</code> array.</p>
</div>
<div class="paragraph">
<p>In addition to the obligation to create a log entry, a policy could specify the advice to inform the system administrator via email about the access.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="policy-evaluation"><a class="anchor" href="#policy-evaluation"></a>Policy Evaluation</h3>
<div class="paragraph">
<p>To come to the final decision included in the authorization decision object, the PDP evaluates all existing policy sets and top-level policies (i.e., policies which are not part of a policy set) against the authorization subscription and combines the results. Each policy set and policy evaluates to <code>PERMIT</code>, <code>DENY</code>, <code>NOT_APPLICABLE</code>, or <code>INDETERMINATE</code> (see <a href="#evaluation">below</a>). The PDP can be configured with a <strong>combining algorithm</strong> which determines how to deal with multiple results. E.g., if access should only be granted if at least one policy evaluates to <code>PERMIT</code> and should be denied. Otherwise, the algorithm <code>deny-unless-permit</code> could be used.</p>
</div>
<div class="paragraph">
<p>Available combining algorithms for the PDP are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The algorithm <code>first-applicable</code> is not available for the PDP since the PDP&#8217;s collection of policy sets and policies is an unordered set.</p>
</div>
<div class="paragraph">
<p>The combining algorithms are described in more detail <a href="#combining-algorithms">later</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="multi-subscriptions"><a class="anchor" href="#multi-subscriptions"></a>Multi-Subscriptions</h3>
<div class="paragraph">
<p>SAPL allows for bundling multiple authorization subscriptions into one multi-subscription. A multi-subscription is a JSON object with the following structure:</p>
</div>
<div class="listingblock">
<div class="title">Multi-Subscriptions - JSON Structure</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "subjects"                   : ["bs@simpsons.com", "ms@simpsons.com"],
  "actions"                    : ["read"],
  "resources"                  : ["file://example/med/record/patient/BartSimpson",
                                  "file://example/med/record/patient/MaggieSimpson"],
  "environments"               : [],

  "authorizationSubscriptions" : {
                                   "id-1" : { "subjectId": 0, "actionId": 0, "resourceId": 0 },
                                   "id-2" : { "subjectId": 1, "actionId": 0, "resourceId": 1 }
                                 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It contains distinct lists of all subjects, actions, resources, and environments referenced by the single authorization subscriptions being part of the multi-subscription. The authorization subscriptions themselves are stored in a map of subscription IDs pointing to an object defining an authorization subscription by providing indexes into the four lists mentioned before.</p>
</div>
<div class="paragraph">
<p>The multi-subscription shown in the example above contains two authorization subscriptions. The user <code>bs@simpsons.com</code> wants to <code>read</code> the file <code><a href="file://example/med/record/patient/BartSimpson" class="bare">file://example/med/record/patient/BartSimpson</a></code>, and the user <code>ms@simpsons.com</code> wants to <code>read</code> the file <code><a href="file://example/med/record/patient/MaggieSimpson" class="bare">file://example/med/record/patient/MaggieSimpson</a></code>.</p>
</div>
<div class="paragraph">
<p>The SAPL PDP processes all individual authorization subscriptions contained in the multi-subscription in parallel and returns the related authorization decisions as soon as they are available, or it collects all the authorization decisions of the individual authorization subscriptions and returns them as a multi-decision. In both cases, the authorization decisions are associated with the subscription IDs of the related authorization subscription. The following listings show the JSON structures of the two authorization decision types:</p>
</div>
<div class="listingblock">
<div class="title">Single Authorization Decision with Associated Subscription ID - JSON Structure</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "authorizationSubscriptionId" : "id-1",
  "authorizationDecision"       : {
                                    "decision" : "PERMIT",
                                    "resource" : { ... }
                                  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Multi-Decision - JSON Structure</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "authorizationDecisions" : {
                               "id-1" : {
                                          "decision" : "PERMIT",
                                          "resource" : { ... }
                                        },
                               "id-2" : {
                                          "decision" : "DENY"
                                        }
                             }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pdp-apis"><a class="anchor" href="#pdp-apis"></a>PDP APIs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A SAPL PDP must expose a publish-subscribe API for subscribing via the subscription objects laid out above. SAPL defines two specific APIs for that. One is an HTTP Server-Sent Events (SSE) API for deploying a dedicated PDP Server, the other for using a PDP in reactive Java applications. The Java API may be implemented by an embedded PDP or by using the SSE API of a remote server.</p>
</div>
<div class="sect2">
<h3 id="http-server-sent-events-api"><a class="anchor" href="#http-server-sent-events-api"></a>HTTP Server-Sent Events API</h3>
<div class="paragraph">
<p>A PDP to be used as a network service must implement some HTTP endpoints.
All of them accept <code>POST</code> requests and <code>application/json</code>. They produce <code>application/x-ndjson</code> as <a href="https://www.w3.org/TR/eventsource/">Server-Sent Events (SSE)</a>. A PDP server must be accessed over encrypted TLS connections. All connections should be authenticated. The means of authentications are left open for the organization deploying the PDP to decide or to be defined by a specific server implementation. All endpoints should be located under a shared base URL, e.g., <code><a href="https://pdp.sapl.io/api/pdp/" class="bare">https://pdp.sapl.io/api/pdp/</a></code>.</p>
</div>
<div class="paragraph">
<p>A PEP which is a client to the SSE PDP API encountering connectivity issues or errors, must interpret this as an INDETERMINATE decision and thus deny access during this time of uncertainty and take appropriate steps to reconnect with the PDP, using a matching back-off strategy to not overload the PDP.</p>
</div>
<div class="paragraph">
<p>A PEP must determine if it can enforce obligations before granting access. It must enforce obligation upon granting access at the point in time (e.g., before or after granting access) implied by the semantics of the obligation, and it should enforce any advice at their appropriate point in time when possible.</p>
</div>
<div class="paragraph">
<p>Upon subscription, the PDP server will respond with an unbound stream of decisions. The client must close the connection to stop receiving decision events. A connection termination by the server is an error state and must be handled as discussed.</p>
</div>
<div class="sect3">
<h4 id="decide"><a class="anchor" href="#decide"></a>Decide</h4>
<div class="ulist">
<ul>
<li>
<p>URL:  <code>{baseURL}/decide</code></p>
</li>
<li>
<p>Method: <code>POST</code></p>
</li>
<li>
<p>Body: A valid JSON authorization subscription</p>
</li>
<li>
<p>Produces: A SSE stream of authorization decisions</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="multi-decide"><a class="anchor" href="#multi-decide"></a>Multi Decide</h4>
<div class="ulist">
<ul>
<li>
<p>URL:  <code>{baseURL}/multi-decide</code></p>
</li>
<li>
<p>Method: <code>POST</code></p>
</li>
<li>
<p>Body: A valid JSON multi subscription</p>
</li>
<li>
<p>Produces: A SSE stream of Single Authorization Decisions with Associated Subscription ID JSON Objects</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="multi-decide-all"><a class="anchor" href="#multi-decide-all"></a>Multi Decide All</h4>
<div class="ulist">
<ul>
<li>
<p>URL:  <code>{baseURL}/multi-decide-all</code></p>
</li>
<li>
<p>Method: <code>POST</code></p>
</li>
<li>
<p>Body: A valid JSON multi subscription</p>
</li>
<li>
<p>Produces: A SSE stream of Multi Decision JSON Objects</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="implementations"><a class="anchor" href="#implementations"></a>Implementations</h4>
<div class="paragraph">
<p>The SAPL Policy engine comes with two implementations ready for deployment in an organization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAPL Server LT: This light (LT) PDP server implementation uses a configuration and policies stored on a file system. The server is available as a docker container. Documentation: <a href="https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-server-lt" class="bare">https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-server-lt</a></p>
</li>
<li>
<p>SAPL Server CE: This community edition (CE) PDP server implementation uses a relational database (MariaDB) for persistence configuration and offers a convenient graphical Web interface to manage policies, configuration, and clients. The UI includes SAPL specific text editors with syntax highlighting and auto-completion features. The server is available as a docker container. Documentation: <a href="https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-server-ce" class="bare">https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-server-ce</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="java-api"><a class="anchor" href="#java-api"></a>Java API</h3>
<div class="paragraph">
<p>The Java API is based on the reactive libraries of Project Reactor (<a href="https://projectreactor.io/" class="bare">https://projectreactor.io/</a>). The API is defined in the <code>sapl-pdp-api</code> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-pdp-api&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key interface is the <code>PolicyDecisionPoint</code> exposing methods matching the PDP server HTTP SSE API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * The policy decision point is the component in the system, which will take an
 * authorization subscription, retrieve matching policies from the policy
 * retrieval point, evaluate the policies while potentially consulting external
 * resources (e.g., through attribute finders), and return a {@link Flux} of
 * authorization decision objects.
 *
 * This interface offers methods to hand over an authorization subscription to
 * the policy decision point, differing in the construction of the
 * underlying authorization subscription object.
 */
public interface PolicyDecisionPoint {

    /**
     * Takes an authorization subscription object and returns a {@link Flux}
     * emitting matching authorization decisions.
     *
     * @param authzSubscription the SAPL authorization subscription object
     * @return a {@link Flux} emitting the authorization decisions for the given
     *         authorization subscription. New authorization decisions are only
     *         added to the stream if they are different from the preceding
     *         authorization decision.
     */
    Flux&lt;AuthorizationDecision&gt; decide(AuthorizationSubscription authzSubscription);

    /**
     * Multi-subscription variant of {@link #decide(AuthorizationSubscription)}.
     *
     * @param multiAuthzSubscription the multi-subscription object containing the
     *                               subjects, actions, resources, and environments
     *                               of the authorization subscriptions to be
     *                               evaluated by the PDP.
     * @return a {@link Flux} emitting authorization decisions for the given
     *         authorization subscriptions as soon as they are available. Related
     *         authorization decisions and authorization subscriptions have the same
     *         id.
     */
    Flux&lt;IdentifiableAuthorizationDecision&gt; decide(MultiAuthorizationSubscription multiAuthzSubscription);

    /**
     * Multi-subscription variant of {@link #decide(AuthorizationSubscription)}.
     *
     * @param multiAuthzSubscription the multi-subscription object containing the
     *                               subjects, actions, resources, and environments
     *                               of the authorization subscriptions to be
     *                               evaluated by the PDP.
     * @return a {@link Flux} emitting authorization decisions for the given
     *         authorization subscriptions as soon as at least one authorization
     *         decision for each authorization subscription is available.
     */
    Flux&lt;MultiAuthorizationDecision&gt; decideAll(MultiAuthorizationSubscription multiAuthzSubscription);

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="embedded-pdp"><a class="anchor" href="#embedded-pdp"></a>Embedded PDP</h4>
<div class="paragraph">
<p>To use a PDP two implementations of the API are supplied. First, a completely embedded PDP can be used to be deployed with an application. (See: <a href="https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-pdp-embedded" class="bare">https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-pdp-embedded</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-pdp-embedded&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The library with Spring auto configuration support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-spring-pdp-embedded&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remote-pdp"><a class="anchor" href="#remote-pdp"></a>Remote PDP</h4>
<div class="paragraph">
<p>Alternatively, a remote PDP server can be used via the same interface by using the client implementation. (See: <a href="https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-pdp-remote" class="bare">https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-pdp-remote</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-pdp-remote&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The library with Spring auto configuration support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-spring-pdp-remote&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring-security-integration-and-pep-implementation"><a class="anchor" href="#spring-security-integration-and-pep-implementation"></a>Spring Security Integration and PEP Implementation</h4>
<div class="paragraph">
<p>For Spring Security (<a href="https://spring.io/projects/spring-security" class="bare">https://spring.io/projects/spring-security</a>), a full PEP implementation is available. A matching Spring PDP implementation also must be declared to use the integration (see above).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">   &lt;dependency&gt;
      &lt;groupId&gt;io.sapl&lt;/groupId&gt;
      &lt;artifactId&gt;sapl-spring-security&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-sapl-policy-language"><a class="anchor" href="#the-sapl-policy-language"></a>The SAPL Policy Language</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SAPL defines a feature-rich domain-specific language (DSL) for creating access policies.
Those access policies describe when access requests will be granted and when access will be denied. The underlying concept to describe these permissions is an attribute-based access control model (ABAC): A SAPL authorization subscription is a JSON object with the attributes <code>subject</code>, <code>action</code>, <code>resource</code> and <code>environment</code> each with an assigned JSON value. Each of these values may be a JSON object itself containing multiple attributes. Policies can use of Boolean conditions referring to those attributes (e.g., <code>subject.username == "admin"</code>).</p>
</div>
<div class="paragraph">
<p>However, a role-based access control (RBAC) system in which permissions are assigned to a certain role and roles can be assigned to users can be created with SAPL as well.</p>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>Overview</h3>
<div class="paragraph">
<p>SAPL knows two types of documents: Policy sets and policies. The decisions of the PDP are based on all documents published in the policy store of the PDP.
A policy set contains an ordered set of connected policies.</p>
</div>
<div class="sect3">
<h4 id="policy-structure"><a class="anchor" href="#policy-structure"></a>Policy Structure</h4>
<div class="paragraph">
<p>A SAPL policy consists of optional <strong>imports</strong>,  a <strong>name</strong>, an <strong>entitlement</strong> specification, an optional <strong>target expression</strong>, an optional <strong>body</strong> with one or more statements, and optional sections for <strong>obligation</strong>, <strong>advice</strong>, and <strong>transformation</strong>. An example of a simple policy is:</p>
</div>
<div class="listingblock">
<div class="title">Sample SAPL Policy</div>
<div class="content">
<pre class="highlight"><code>import filter as filter <i class="conum" data-value="1"></i><b>(1)</b>

policy "test_policy" <i class="conum" data-value="2"></i><b>(2)</b>
permit <i class="conum" data-value="3"></i><b>(3)</b>
    subject.id == "anId" | action == "anAction" <i class="conum" data-value="4"></i><b>(4)</b>
where
    var variable = "anAttribute";
    subject.attribute == variable; <i class="conum" data-value="5"></i><b>(5)</b>
obligation
    "logging:log_access" <i class="conum" data-value="6"></i><b>(6)</b>
advice
    "logging:inform_admin" <i class="conum" data-value="7"></i><b>(7)</b>
transform
    resource.content |- filter.blacken <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Imports (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Entitlement</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Target Expression (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Body (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Obligation (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Advice (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Transformation (optional)</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="policy-set-structure"><a class="anchor" href="#policy-set-structure"></a>Policy Set Structure</h4>
<div class="paragraph">
<p>A SAPL policy set contains optional <strong>imports</strong>, a <strong>name</strong>, a <strong>combining algorithm</strong>, an optional <strong>target expression</strong>, optional <strong>variable definitions</strong>, and a list of <strong>policies</strong>. The following example shows a simple policy set with two policies:</p>
</div>
<div class="listingblock">
<div class="title">Sample SAPL Policy Set</div>
<div class="content">
<pre class="highlight"><code>import filter.* <i class="conum" data-value="1"></i><b>(1)</b>

set "test_policy_set" <i class="conum" data-value="2"></i><b>(2)</b>
deny-unless-permit <i class="conum" data-value="3"></i><b>(3)</b>
for resource.type == "aType" <i class="conum" data-value="4"></i><b>(4)</b>
var dbUser = "admin";<i class="conum" data-value="5"></i><b>(5)</b>

    policy "test_permit_admin" <i class="conum" data-value="6"></i><b>(6)</b>
    permit subject.function == "admin"

    policy "test_permit_read" <i class="conum" data-value="7"></i><b>(7)</b>
    permit action == "read"
    transform resource |- blacken</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Imports (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Combining Algorithm</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Target Expression (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Variable Assignments (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Policy 1</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Policy 2</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="imports"><a class="anchor" href="#imports"></a>Imports</h3>
<div class="paragraph">
<p>SAPL provides access to functions or attribute finders stored in libraries. The names of those libraries usually consist of different parts separated by periods (e.g., <code>sapl.pip.http</code> - a library containing functions to obtain attributes through HTTP requests). In policy documents, the functions and finders can be accessed by their fully qualified name, i.e., the name of the library followed by a period (<code>.</code>) and the function or finder name, e.g., <code>sapl.pip.http.get</code>.</p>
</div>
<div class="paragraph">
<p>For any SAPL top-level document (i.e., a policy set or a policy that is not part of a policy set), any number of imports can be specified. Imports allow using a shorter name instead of the fully qualified name for a function or an attribute finder within a SAPL document. Thus, imports can make policy sets and policies easier to read and write.</p>
</div>
<div class="paragraph">
<p>Each import statement starts with the keyword <code>import</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Basic Import</strong>: A function or an attribute finder can be imported by providing its fully qualified name (e.g., <code>import sapl.pip.http.get</code>). It will be available under its simple name (in the example: <code>get</code>) in the whole SAPL document.</p>
</li>
<li>
<p><strong>Wildcard Import</strong>: All functions or attribute finders from a library can be imported by providing an asterisk instead of a function or finder name (e.g., <code>import sapl.pip.http.*</code>). All functions or finders from the library will be available under their simple names (in the example: <code>get</code>).</p>
</li>
<li>
<p><strong>Library Alias Import</strong>: All functions or attribute finders from a library can be imported by providing the library name followed by <code>as</code> and an alias, e.g., <code>import sapl.pip.http as rest</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The SAPL document can contain any number of imports, e.g.</p>
</div>
<div class="listingblock">
<div class="title">Sample Imports</div>
<div class="content">
<pre class="highlight"><code>import sapl.pip.http.*
import filter.blacken
import simple.append

policy "sample"
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-policy"><a class="anchor" href="#sapl-policy"></a>SAPL Policy</h3>
<div id="policy" class="paragraph">
<p>This section describes the elements of a SAPL policy in more detail. A policy contains an entitlement (<code>permit</code> or <code>deny</code>) and can be evaluated against an authorization subscription. If the conditions in the target expression and in the body are fulfilled, the policy evaluates to its entitlement. Otherwise, it evaluates to <code>NOT_APPLICABLE</code> (if one of the conditions is not satisfied) or <code>INDETERMINATE</code> (if an error occurred).</p>
</div>
<div class="paragraph">
<p>A SAPL policy starts with the keyword <code>policy</code>.</p>
</div>
<div class="sect3">
<h4 id="name"><a class="anchor" href="#name"></a>Name</h4>
<div class="paragraph">
<p>The keyword <code>policy</code> is followed by the policy name. The name is a string <em>identifying</em> the policy. Therefore, it must be unique. Accordingly, in systems with many policy sets and policies, it is recommended to use a schema to create names (e.g., <code>"policy:patientdata:permit-doctors-read"</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="entitlement"><a class="anchor" href="#entitlement"></a>Entitlement</h4>
<div class="paragraph">
<p>SAPL expects an entitlement specification. This can either be <code>permit</code> or <code>deny</code>. The entitlement is the value to which the policy evaluates if the policy is applicable to the authorization subscription, i.e., if both the conditions in the policy&#8217;s target expression and in the policy&#8217;s body are satisfied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since multiple policies can be applicable and the combining algorithm can be chosen, it might make a difference whether there is an explicit <code>deny</code>-policy or whether there is just no permitting policy for a certain situation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="target-expression"><a class="anchor" href="#target-expression"></a>Target Expression</h4>
<div class="paragraph">
<p>After the entitlement, an <strong>optional</strong> target expression can be specified. This is a condition for applying the policy, hence an expression that must evaluate to either <code>true</code> or <code>false</code>. Which elements are allowed in SAPL expressions is described <a href="#expressions">below</a>.</p>
</div>
<div class="paragraph">
<p>If the target expression evaluates to <code>true</code> for a certain authorization subscription, the policy <em>matches</em> this subscription. A missing target expression makes the policy match any subscription.</p>
</div>
<div class="paragraph">
<p>A matching policy whose conditions in the body evaluate to <code>true</code> is called <em>applicable</em> to an authorization subscription and returns its entitlement. Both target expression and body define conditions that must be satisfied for the policy to be applicable. Although they seem to serve a similar purpose, there is an important difference: For an authorization subscription, the target expression of each top-level document is checked to select policies matching the subscription from a possibly large set of policy documents. Indexing mechanisms may be used to fulfill this task efficiently.</p>
</div>
<div class="paragraph">
<p>Accordingly, there are two limitations regarding the elements allowed in the target:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As lazy evaluation deviates from Boolean logic and prevents effective indexing, the logical operators <code>&amp;&amp;</code> and <code>||</code> may not be used. Instead, the target needs to use the operators <code>&amp;</code> and <code>|</code>, for which eager evaluation is applied.</p>
</li>
<li>
<p><a href="#attribute-finders">Attribute finder steps</a> that have access to environment variables and may contact external PIPs are not allowed in the target. Functions may be used because their output only depends on the arguments passed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="body"><a class="anchor" href="#body"></a>Body</h4>
<div class="paragraph">
<p>The policy body is <strong>optional</strong> and starts with the keyword <code>where</code>. It contains one or more statements, each of which must evaluate to <code>true</code> for the policy to apply to a certain authorization subscription. Accordingly, the body extends the condition in the target expression and further limits the policy&#8217;s applicability.</p>
</div>
<div class="paragraph">
<p>A statement within the body can either be a variable assignment which makes a variable available under a certain name (and always evaluates to <code>true</code>)</p>
</div>
<div class="listingblock">
<div class="title">Sample Variable Assignment</div>
<div class="content">
<pre class="highlight"><code>var a_name = expression;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or a condition, i.e., an expression that evaluates to <code>true</code> or <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="title">Sample Condition</div>
<div class="content">
<pre class="highlight"><code>a_name == "a_string";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each statement is concluded with a semicolon <code>;</code>.</p>
</div>
<div class="paragraph">
<p>There are no restrictions on the syntax elements allowed in the policy body. Lazy evaluation is used for the conjunction of the statements - i.e., if one statement evaluates to <code>false</code>, the policy returns the decision <code>NOT_APPLICABLE</code>, even if future statements would cause an error.</p>
</div>
<div class="paragraph">
<p>If the body is missing (or does not contain any condition statement), the policy is applicable to any authorization subscription which the policy matches (i.e., for which the target expression evaluates to <code>true</code>).</p>
</div>
<div class="sect4">
<h5 id="variable-assignment"><a class="anchor" href="#variable-assignment"></a>Variable Assignment</h5>
<div id="value-assignment" class="paragraph">
<p>A variable assignment starts with the keyword <code>var</code>, followed by an identifier under which the assigned value should be available, followed by <code>=</code> and an expression.</p>
</div>
<div class="paragraph">
<p>After a variable assignment, the result of evaluating the expression can be used in later conditions within the same policy under the specified name. This is useful because it allows to execute time-consuming calculations or requests to external attribute stores only once, and the result can be used in multiple expressions. Additionally, it can make policies shorter and improve readability.</p>
</div>
<div class="paragraph">
<p>The expression can use any element of the SAPL expression language, especially of attribute finder steps that are not allowed in the target expression.</p>
</div>
<div class="paragraph">
<p>The value assignment statement always evaluates to <code>true</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="condition"><a class="anchor" href="#condition"></a>Condition</h5>
<div class="paragraph">
<p>A condition statement simply consists of an expression that must evaluate to <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The expression can use any element of the SAPL expression language, especially of attribute finder steps that are not allowed in the target expression. Conditions in the policy body are used to further limit the applicability of a policy.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obligation-2"><a class="anchor" href="#obligation-2"></a>Obligation</h4>
<div class="paragraph">
<p>An <strong>optional</strong> obligation expression contains a task which the PEP must fulfill before granting or denying access. It consists of the keyword <code>obligation</code> followed by an expression.</p>
</div>
<div class="paragraph">
<p>A common situation in which obligations are useful is <em>Break the Glass Scenarios</em>. Assuming in case of an emergency, a doctor should also have access to medical records that she normally cannot read. However, this emergency access must be logged to prevent abuse. In this situation, logging is a requirement for granting access and therefore must be commanded in an obligation.</p>
</div>
<div class="paragraph">
<p>Obligations are only returned in the authorization decision if the decision is <code>PERMIT</code> or <code>DENY</code>. The PDP simply collects all obligations from policies evaluating to one of these entitlements. Depending on the final decision, the obligations and advice which belong to this decision are included in the authorization decision object. It does not matter if the obligation is described with a string (like <code>"create_emergency_access_log"</code>) or an object (like <code>{ "task" : "create_log", "content" : "emergency_access" }</code>) or another JSON value - only the PEP must be implemented in a way that it knows how to process these obligations.</p>
</div>
</div>
<div class="sect3">
<h4 id="advice-2"><a class="anchor" href="#advice-2"></a>Advice</h4>
<div class="paragraph">
<p>An <strong>optional</strong> advice expression is treated similarly to an obligation expression. Unlike obligations, fulfilling the described tasks in the advice is not a requirement for granting or denying access. The advice expression consists of the keyword <code>advice</code> followed by any expression.</p>
</div>
<div class="paragraph">
<p>If the final decision is <code>PERMIT</code> or <code>DENY</code>, advice from all policies evaluating to this decision is included in the authorization decision object by the PDP.</p>
</div>
</div>
<div class="sect3">
<h4 id="transformation"><a class="anchor" href="#transformation"></a>Transformation</h4>
<div class="paragraph">
<p>An <strong>optional</strong> transformation statement is preluded with the keyword <code>transform</code> and followed by an expression. If a transformation statement is supplied and the policy evaluates to <code>permit</code>, the result of evaluating the expression will be returned as the <code>resource</code> in the authorization decision object.</p>
</div>
<div class="paragraph">
<p>Accordingly, a transformation statement might be used to hide certain information (e.g., <em>a doctor can access patient data but should not see bank account details</em>). This can be reached by applying a filter to the original resource, which removes or blackens certain attributes. Thus, SAPL allows for <strong>fine-grained</strong> or <strong>field-level</strong> access control without the need to treat each attribute as a resource and write a specific  policy for it.</p>
</div>
<div class="paragraph">
<p>The original resource is accessible via the identifier <code>resource</code> and can be filtered as follows:</p>
</div>
<div class="listingblock">
<div class="title">Transformation Example</div>
<div class="content">
<pre>transform
    resource |- {
        @.someValue : remove,
        @.anotherValue : filter.blacken
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The example would remove the attribute <code>someValue</code> and blacken the value of the attribute <code>anotherValue</code>. The filtering functions are described in more detail <a href="#filtering">below</a>.</p>
</div>
<div class="paragraph">
<p>It is not possible to combine multiple transformation statements through multiple policies. Each combining algorithm in SAPL will not return the decision <code>PERMIT</code> if there is more than one policy evaluating to <code>PERMIT</code>, and at least one of them contains a transformation statement (this is called <em>transformation uncertainty</em>). For more details, <a href="#combining-algorithms">see below</a>.</p>
</div>
<div class="paragraph">
<p>Transformation statements can be interpreted as a special case of obligation, requiring the PEP to replace the resource accordingly.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-policy-set"><a class="anchor" href="#sapl-policy-set"></a>SAPL Policy Set</h3>
<div class="paragraph">
<p>While a policy can either be a top-level SAPL document or be contained in a policy set, policy sets are always top-level documents. I.e., for evaluating an authorization subscription, the PDP evaluates an existing policy set. Policy sets are evaluated against an authorization subscription by checking their target expression, if applicable evaluating their policies, and, if necessary, combining multiple decisions according to a combining algorithm specified in the policy set. Finally, similarly to policies, policy sets evaluate to either <code>PERMIT</code>, <code>DENY</code>, <code>NOT_APPLICABLE</code> or <code>INDETERMINATE</code>.</p>
</div>
<div class="paragraph">
<p>Policy sets are used to structure multiple policies and provide an order for the policies they contain. Hence, their policies can be evaluated one after another.</p>
</div>
<div class="paragraph">
<p>A policy set definition starts with the keyword <code>set</code>.</p>
</div>
<div class="sect3">
<h4 id="name-2"><a class="anchor" href="#name-2"></a>Name</h4>
<div class="paragraph">
<p>The keyword <code>set</code> is followed by the policy set name. The name is a string <em>identifying</em> the policy set. It must be unique within all policy sets and policies.</p>
</div>
</div>
<div class="sect3">
<h4 id="combining-algorithm"><a class="anchor" href="#combining-algorithm"></a>Combining Algorithm</h4>
<div class="paragraph">
<p>The name is followed by a combining algorithm. This algorithm describes how to combine the results by evaluating every policy to come to a result for the policy set.</p>
</div>
<div class="paragraph">
<p>Possible values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
<li>
<p><code>first-applicable</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The combining algorithms are described in more detail <a href="#combining-algorithms">later</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="target-expression-2"><a class="anchor" href="#target-expression-2"></a>Target Expression</h4>
<div class="paragraph">
<p>After the combining algorithm, an <strong>optional</strong> target expression can be specified. The target expression is a condition for applying the policy set. It starts with the keyword <code>for</code> followed by an expression that must evaluate to either <code>true</code> or <code>false</code>. If the condition evaluates to <code>true</code> for a certain authorization subscription, the policy set <em>matches</em> this subscription. In case the target expression is missing, the policy set matches any authorization subscription.</p>
</div>
<div class="paragraph">
<p>The policy sets' target expression is used to select matching policy sets from a large collection of policy documents before evaluating them. As this needs to be done efficiently, there are no <a href="#attribute-finders">attribute finder steps</a> allowed at this place.</p>
</div>
</div>
<div class="sect3">
<h4 id="variable-assignments"><a class="anchor" href="#variable-assignments"></a>Variable Assignments</h4>
<div id="policy-set-value-assignments" class="paragraph">
<p>The target expression can be followed by any number of variable assignments. Variable assignments are used to make a value available in all subsequent policies under a certain name. An assignment starts with the keyword <code>var</code>, followed by an identifier under which the assigned value should be available, followed by <code>=</code> and an expression (see <a href="#value-assignment">above</a>).</p>
</div>
<div class="paragraph">
<p>Since variable assignments are only evaluated if the policy set&#8217;s target matches, attribute finders may be used.</p>
</div>
<div class="paragraph">
<p>In case a policy within the policy set assigns a variable already assigned in the policy set, the assignment in the policy overwrites the old. The overwritten value only exists within the particular policy. In other policies, the variable has the value defined in the policy set.</p>
</div>
</div>
<div class="sect3">
<h4 id="policies"><a class="anchor" href="#policies"></a>Policies</h4>
<div class="paragraph">
<p>Each policy set must contain one or more policies. <a href="#policy">See above</a> how to describe a SAPL policy. If the combining algorithm <code>first-applicable</code> is used, the policies are evaluated in the order in which they appear in the policy set.</p>
</div>
<div class="paragraph">
<p>In each policy, functions and attribute finders imported at the beginning of the SAPL document can be used under their shorter name. All variables assigned for the policy set (see <a href="#policy-set-value-assignments">Value Assignments</a>) are available within the policies but can be overwritten for a particular policy. The same applies to imports - imports at the policy level overwrite imports defined for the policy set but are only valid for the particular policy.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="language-elements"><a class="anchor" href="#language-elements"></a>Language Elements</h3>
<div class="paragraph">
<p>The descriptions of the policy and policy set structure sometimes refer to language elements like identifiers and strings. These elements are explained in this section.</p>
</div>
<div class="sect3">
<h4 id="identifiers"><a class="anchor" href="#identifiers"></a>Identifiers</h4>
<div class="paragraph">
<p>Multiple elements in policies or policy sets require identifiers. E.g., a variable assignment expects an identifier after the keyword <code>var</code> - the name under which the assigned value will be available.</p>
</div>
<div class="paragraph">
<p>An identifier only consists of alphanumeric characters, <code>_</code> and <code>$</code>, and must not start with a number.</p>
</div>
<div class="listingblock">
<div class="title">Valid Identifiers</div>
<div class="content">
<pre class="highlight"><code>a_long_name
aLongName
$name
_name
name123</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Invalid Identifiers</div>
<div class="content">
<pre class="highlight"><code>a#name
1name</code></pre>
</div>
</div>
<div class="paragraph">
<p>A caret <code>^</code> before the identifier may be used to avoid a conflict with SAPL keywords.</p>
</div>
</div>
<div class="sect3">
<h4 id="strings"><a class="anchor" href="#strings"></a>Strings</h4>
<div class="paragraph">
<p>Whenever strings are expected, the SAPL document must contain any sequence of characters enclosed by single quotes <code>'</code> or double quotes <code>"</code>. Any enclosing quote character occurring in the string must be escaped by a preceding <code>\</code>, e.g., <code>"the name is \"John Doe\""</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="comments"><a class="anchor" href="#comments"></a>Comments</h4>
<div class="paragraph">
<p>Comments are used to store information in a SAPL document which is only intended for human readers and has no meaning for the PDP. Comments are simply ignored when the PDP evaluates a document.</p>
</div>
<div class="paragraph">
<p>SAPL supports single-line and multi-line comments. A single-line comment starts with <code>//</code> and ends at the end of the line, no matter which characters follow.</p>
</div>
<div class="listingblock">
<div class="title">Sample Single-Line Comment</div>
<div class="content">
<pre class="highlight"><code>policy "test" // a policy for testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multi-line comments start with <code>/*</code> and end with <code>*/</code>. Everything in between is ignored.</p>
</div>
<div class="listingblock">
<div class="title">Sample Multi-Line Comment</div>
<div class="content">
<pre class="highlight"><code>policy "test"
/* A policy for testing.
Remove before deployment! */</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-expressions"><a class="anchor" href="#sapl-expressions"></a>SAPL Expressions</h3>
<div id="expressions" class="paragraph">
<p>To ensure flexibility, various parts of a policy can be <strong>expressions</strong> that are evaluated at runtime. E.g., a policy&#8217;s target must be an expression evaluating to <code>true</code> or <code>false</code>. SAPL contains a uniform expression language that offers various useful features while still being easy to read and write.</p>
</div>
<div class="paragraph">
<p>Since JSON is the base data model, each expression evaluates to a JSON data type. These data types and the expression syntax are described in this section.</p>
</div>
<div class="sect3">
<h4 id="json-data-types"><a class="anchor" href="#json-data-types"></a>JSON Data Types</h4>
<div class="paragraph">
<p>SAPL is based on the <strong>JavaScript Object Notation</strong> or <strong>JSON</strong>, an <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf">ECMA Standard</a> for the representation of structured data.
Any value occurring within the SAPL language is a JSON data type, and any expression within a policy evaluates to a JSON data type.
The types and their JSON notations are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitive Types</p>
<div class="ulist">
<ul>
<li>
<p><strong>Number</strong>: A signed decimal number, e.g., <code>-1.9</code>. There is no distinction between integer and floating-point numbers. In case an integer is expected (e.g., for a numeric index), the decimal number is rounded to an integer number.</p>
</li>
<li>
<p><strong>String</strong>: A sequence of zero or more characters, written in double or single quotes, e.g., <code>"a string"</code> or <code>'a string'</code>.</p>
</li>
<li>
<p><strong>Boolean</strong>: Either <code>true</code> or <code>false</code>.</p>
</li>
<li>
<p><strong>null</strong>: Marks an empty value, <code>null</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Structured Types</p>
<div class="ulist">
<ul>
<li>
<p><strong>Object</strong>: An unordered set of name/value pairs. The name is a string. The value must be one of the available data types. It can also be an object itself. The name/value pair is also called an attribute of the object. E.g.</p>
<div class="listingblock">
<div class="content">
<pre>{
    "firstAttribute" : "first value",
    "secondAttribute" : 123
}</pre>
</div>
</div>
</li>
<li>
<p><strong>Array</strong>: An ordered sequence of zero or more values of any JSON data type. E.g.</p>
<div class="listingblock">
<div class="content">
<pre>[
    "A value",
    123,
    {"attribute" : "value"}
]</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="expression-types"><a class="anchor" href="#expression-types"></a>Expression Types</h4>
<div class="paragraph">
<p>SAPL knows <strong>basic expressions</strong> and <strong>operator expressions</strong> (created from other expressions using operators).</p>
</div>
<div class="paragraph">
<p>A <strong>basic expression</strong> is either a</p>
</div>
<div id="basic-relative" class="ulist">
<ul>
<li>
<p><strong>Value Expression</strong>: a value explicitly defined in the corresponding JSON notation (e.g., <code>"a value"</code>)</p>
</li>
<li>
<p><strong>Identifier Expression</strong>: the name of a variable or of an authorization subscription attribute (<code>subject</code>, <code>resource</code>, <code>action</code>, or <code>environment</code>)</p>
</li>
<li>
<p><strong>Function Expression</strong>: a function call (e.g., <code>simple.get_minimum(resource.array)</code>)</p>
</li>
<li>
<p><strong>Relative Expression</strong>: <code>@</code>, which refers to a certain value depending on the context</p>
</li>
<li>
<p><strong>Grouped Expression</strong>: any expression enclosed in parentheses, e.g., <code>(1 + 1)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of these basic expressions can contain one or more <strong>selection steps</strong> (e.g., <code>subject.name</code>, which is the identifier expression <code>subject</code> followed by the selection step <code>.name</code> selecting the value of the <code>name</code> attribute). Additionally, a basic expression can contain a <strong>filter component</strong> (<code>|- Filter</code>) which will be applied to the evaluation result. If the expression evaluates to an array, instead of applying a filter,  each item can be transformed using a <strong>subtemplate component</strong> (<code>:: Subtemplate</code>).</p>
</div>
<div class="paragraph">
<p><strong>Operator expressions</strong> can be constructed using prefix or infix <strong>operators</strong> (e.g., <code>1 + subject.age</code> or <code>! subject.isBlocked</code>). SAPL supports infix and prefix operators. They may be applied in connection with any expression. An operator expression within parentheses (e.g., <code>(1 + subject.age)</code>) is a basic expression again and thus may contain selection steps, filter, or subtemplate statements.</p>
</div>
<div class="sect4">
<h5 id="value-expressions"><a class="anchor" href="#value-expressions"></a>Value Expressions</h5>
<div class="paragraph">
<p>A basic value expression is the simplest type. The value is denoted in the corresponding JSON format.</p>
</div>
<div class="paragraph">
<p><code>true</code>, <code>false</code>, and <code>null</code> are value expressions as well as <code>"a string"</code>, <code>'a string'</code>, or any number (like <code>6</code> or <code>100.51</code>).</p>
</div>
<div class="paragraph">
<p>For denoting objects, the keys need to be strings, and the values can be any expression, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
    "id" : (3+5),
    "name" : functions.generate_name()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For arrays, the items can be any expression, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[
    (3+5),
    subject.name
]</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="identifier-expressions"><a class="anchor" href="#identifier-expressions"></a>Identifier Expressions</h5>
<div class="paragraph">
<p>A basic identifier expression consists of the name of a variable or the name of an authorization subscription attribute (i.e., <code>subject</code>, <code>resource</code>, <code>action</code>, or <code>environment</code>).</p>
</div>
<div class="paragraph">
<p>It evaluates to the variable or the attribute&#8217;s value.</p>
</div>
</div>
<div class="sect4">
<h5 id="function-expressions"><a class="anchor" href="#function-expressions"></a>Function Expressions</h5>
<div class="paragraph">
<p>A basic function expression consists of a function name and any number of arguments between parentheses which are separated by commas. The arguments must be expressions, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>library.a_function(subject.name, (environment.day_of_week + 1))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each function is available under its fully qualified name. The fully qualified name starts with the library name, consisting of one or more identifiers separated by periods <code>.</code> (e.g., <code>sapl.functions.simple</code>). The library name is followed by a period <code>.</code> and an identifier for the function name (e.g., <code>sapl.functions.simple.append</code>). Which function libraries are available depends on the configuration of the PDP.</p>
</div>
<div class="paragraph">
<p><a href="#imports">Imports</a> at the beginning of a SAPL document can be used to make functions available under shorter names. If a function is imported via a basic import or a wildcard import, it is available under its function name (e.g., <code>append</code>). A library alias import provides an alternative library name (e.g., with the import statement <code>import sap.functions.simple as simple</code>, the append function would be available under <code>simple.append</code>.</p>
</div>
<div class="paragraph">
<p>If there are no arguments passed to the function, empty parentheses have to be denoted (e.g., <code>random_number()</code>).</p>
</div>
<div class="paragraph">
<p>When evaluating a function expression, the expressions representing the function call arguments are evaluated first. Afterward, the results are passed to the function as arguments. The expression evaluates to the function&#8217;s return value.</p>
</div>
</div>
<div class="sect4">
<h5 id="relative-expressions"><a class="anchor" href="#relative-expressions"></a>Relative Expressions</h5>
<div class="paragraph">
<p>The basic relative expression is the <code>@</code> symbol.</p>
</div>
<div class="paragraph">
<p>It can be used in various contexts. Those contexts are characterized by an implicit loop with <code>@</code> dynamically evaluating to the current element. Assuming the variable <code>array</code> contains an array with multiple numbers, the expression <code>array[?(@ &gt; 10)]</code> can be used to return any element greater than 10. In this context, <code>@</code> evaluates to the array item for which the condition is currently checked.</p>
</div>
<div class="paragraph">
<p>The contexts in which <code>@</code> can be used are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expressions within a condition step (<code>@</code> evaluates to the array item or attribute value for which the condition expression is currently evaluated)</p>
</li>
<li>
<p>Subtemplate (<code>@</code> evaluates to the array item which is currently going to be replaced by the subtemplate)</p>
</li>
<li>
<p>Arguments of a filter function if <code>each</code> is used (<code>@</code> evaluates to the array item to which the filter function is going to be applied)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="operators"><a class="anchor" href="#operators"></a>Operators</h4>
<div class="paragraph">
<p>SAPL provides a collection of arithmetic, comparison, logical, string and filtering operators, which can be used to build expressions from other expressions.</p>
</div>
<div class="sect4">
<h5 id="arithmetic-operators"><a class="anchor" href="#arithmetic-operators"></a>Arithmetic Operators</h5>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to numbers, the following operators can be applied. All of them evaluate to number.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-exp1</code> (negation)</p>
</li>
<li>
<p><code>exp1 * exp2</code> (multiplication)</p>
</li>
<li>
<p><code>exp1 / exp2</code> (division)</p>
</li>
<li>
<p><code>exp1 + exp2</code> (addition)</p>
</li>
<li>
<p><code>exp1 - exp2</code> (subtraction)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An expression can contain multiple arithmetic operators. The order in which they are evaluated can be specified using <strong>parentheses</strong>, e.g., <code>(1 + 2) * 3</code>.</p>
</div>
<div class="paragraph">
<p>In case multiple operators are used without parentheses (e.g., <code>4 + 3 * 2</code>), the <strong>operator precedence</strong> determines how the expression is evaluated. Operators with higher precedence are evaluated first. The following precedence is assigned to arithmetic operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-</code> (negation): precedence <strong>4</strong></p>
</li>
<li>
<p><code>*</code> (multiplication), <code>/</code> (division): precedence <strong>2</strong></p>
</li>
<li>
<p><code>+</code> (addition), <code>-</code> (subtraction): precedence <strong>1</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As <code>*</code> has a higher precedence than <code>+</code>, <code>4 + 3 * 2</code> would be evaluated as <code>4 + (3 * 2)</code>.</p>
</div>
<div class="paragraph">
<p>Except for the negation, multiple operators with the same precedence (e.g., <code>5 - 2 + 1</code>) are <strong>left-associative</strong>, i.e., <code>5 - 2 + 1</code> is evaluated like <code>(5 - 2) + 1</code>. The negation is non-associative, i.e., <code>--1</code> needs to be replaced by <code>-(-1)</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="comparison-operators"><a class="anchor" href="#comparison-operators"></a>Comparison Operators</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Number comparison</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to numbers, the following operators can be applied. All of them evaluate to <code>true</code> or <code>false</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>exp1 &lt; exp2</code> (<code>true</code> if <code>exp2</code> is greater than <code>exp1</code>)</p>
</li>
<li>
<p><code>exp1 &gt; exp2</code> (<code>true</code> if <code>exp1</code> is greater than <code>exp2</code>)</p>
</li>
<li>
<p><code>exp1 &lt;= exp2</code> (<code>true</code> if <code>exp2</code> is equal to or greater than <code>exp1</code>)</p>
</li>
<li>
<p><code>exp1 &gt;= exp2</code> (<code>true</code> if <code>exp1</code> is equal to or greater than <code>exp2</code>)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Equals</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions, the equals-operator can be used to compare the results:</p>
</div>
<div class="paragraph">
<p><code>exp1 == exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the result of evaluating <code>exp1</code> is equal to the result of evaluating <code>exp2</code>.</p>
</div>
</li>
<li>
<p>Regular Expression</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to strings, the regular expression match operator can be used:</p>
</div>
<div class="paragraph">
<p><code>exp1 =~ exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the result of evaluating <code>exp1</code> matches the pattern contained in the result of evaluating <code>exp2</code>. The pattern needs to be specified according to the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html">java.util.regex package</a>.</p>
</div>
</li>
<li>
<p><code>in</code> (element of)</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> is an expression and <code>exp2</code> is an expression evaluating to an array, the <code>in</code> operator can be used:</p>
</div>
<div class="paragraph">
<p><code>exp1 in exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the array <code>exp2</code> evaluates to contains the result of evaluating <code>exp1</code>. Otherwise, the expression evaluates to <code>false</code>.</p>
</div>
</li>
<li>
<p>Precedence and Associativity</p>
<div class="paragraph">
<p>All comparison operators have precedence <strong>3</strong>. This is important for combining them with logical operators (see below).</p>
</div>
<div class="paragraph">
<p><code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>==</code>,<code>=~</code> and <code>in</code> are <strong>non-associative</strong>, i.e., an expression may not contain multiple comparison operators (like <code>3 &lt; var &lt; 5</code>). However, they can be combined with logical operators which have a different precedence (thus, the faulty example could be replaced by <code>3 &lt; var &amp;&amp; var &lt; 5</code>).</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="logical-operators"><a class="anchor" href="#logical-operators"></a>Logical Operators</h5>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to <code>true</code> or <code>false</code>, the following operators can be applied. The new expression evaluates to <code>true</code> or <code>false</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>!exp1</code> (negation), precedence <strong>4</strong></p>
</li>
<li>
<p><code>exp1 &amp;&amp; exp2</code> or <code>exp1 &amp; exp2</code> (logical AND), precedence <strong>2</strong></p>
</li>
<li>
<p><code>exp1 || exp2</code> or <code>exp1 | exp2</code> (logical OR), precedence <strong>1</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The difference between <code>&amp;&amp;</code> and <code>&amp;</code> (or <code>||</code> and <code>|</code>) is that for <code>&amp;&amp;</code> lazy evaluation is used while <code>&amp;</code> causes eager evaluation. Using <code>&amp;&amp;</code>, if the left side evaluates to <code>false</code> and the right side would cause an error, the result of the operator is <code>false</code>. The right side is not evaluated. The same applies for <code>||</code> if the left side evaluates to <code>true</code>. In this case, the operator evaluates to <code>true</code>, even if the right side would cause an error - the right side is ignored if the result can already be determined. This is different for <code>&amp;</code> and <code>|</code> which always evaluate both sides first (eager evaluation). Whenever there is an error, the expression does not return a result. In a target expression, only the eager evaluation expressions <code>&amp;</code> and <code>|</code> can be used.</p>
</div>
<div class="paragraph">
<p>The operators are already listed in descending order of their <strong>precedence</strong>, i.e., <code>!</code> has the highest precedence followed by <code>&amp;&amp;</code>/<code>&amp;</code> and <code>||</code>/<code>|</code>. The order of evaluation can be changed by using parentheses.</p>
</div>
<div class="paragraph">
<p><code>&amp;&amp;</code> and <code>||</code> are left-associative, i.e., in case an expression contains multiple operators the leftmost operator is evaluated first. <code>!</code> is non-associative, i.e., <code>!!true</code> must be replaced by <code>!(!true))</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="string-concatenation"><a class="anchor" href="#string-concatenation"></a>String Concatenation</h5>
<div class="paragraph">
<p>The operator <code>+</code> concatenates two strings, e.g., <code>"Hello" + " World!"</code> evaluates to <code>"Hello World!"</code>.</p>
</div>
<div class="paragraph">
<p>String concatenation is applied if the left operand is an expression evaluating to a string. If the right expression evaluates to a string as well, the two strings are concatenated. Otherwise, an error is thrown.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="selection-steps"><a class="anchor" href="#selection-steps"></a>Selection Steps</h4>
<div class="paragraph">
<p>SAPL provides an easy way of accessing attributes of an object (or items of an array). The <strong>basic access</strong> mechanism has a similar syntax to programming languages like JavaScript or Java (e.g., <code>object.attribute</code>, <code>user.address.street</code> or <code>array[10]</code>). Beyond that, SAPL offers <strong>extended possibilities</strong> for expressing more sophisticated queries against JSON structures (e.g., <code>persons[?(@.age &gt;= 50)]</code>).</p>
</div>
<div class="sect4">
<h5 id="overview-2"><a class="anchor" href="#overview-2"></a>Overview</h5>
<div class="paragraph">
<p>The following table provides an overview of the different types of selection steps.</p>
</div>
<div class="paragraph">
<p>Given that the following object is stored in the variable <code>object</code>:</p>
</div>
<div class="listingblock">
<div class="title">Structure of <code>object</code></div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    "key" : "value1",
    "array1" : [
        { "key" : "value2" },
        { "key" : "value3" }
    ],
    "array2" : [
        1, 2, 3, 4, 5
    ]
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Selection Steps Overview</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Expression</th>
<th class="tableblock halign-left valign-top">Returned Value</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.key</code><br>
<code>object['key']</code><br>
<code>object["key"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>"value1"</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Key step</strong> in dot notation and bracket notation</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array1[0]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>{ "key" : "value2" }</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Index step</strong></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[-1]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>5</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Index step</strong> with negative value n returns the n-th last element</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.*</code><br>
<code>object[*]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlight"><code>[
  "value1",
  [
    { "key" : "value2" },
    { "key" : "value3" }
  ],
  [ 1, 2, 3, 4, 5 ]
]</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Wildcard step</strong> applied to an object, it returns an array with the value of each attribute - applied to an array, it returns the array itself</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[0:-2:2]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 1, 3 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Array slicing step</strong> starting from first to second last element with a step size of two</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object..key</code><br>
<code>object..['key']</code><br>
<code>object..["key"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ "value1", "value2", "value3" ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Recursive descent step</strong> looking for an attribute</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object..[0]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ { "key" : "value2" }, 1 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Recursive descent step</strong> looking for an array index</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[(3+1)]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>5</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Expression step</strong> that evaluates to number (index) - can also evaluate to an attribute name</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[?(@&gt;2)]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 3, 4, 5 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Condition step</strong> that evaluates to true/false, <code>@</code> is a reference to the currently examined item - can also be applied to an object</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[2,3]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 3 , 4 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Union step</strong> for more than one array index</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object["key","array2"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ "value1", [ 1, 2, 3, 4, 5 ] ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Union step</strong> for more than one attribute</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="basic-access"><a class="anchor" href="#basic-access"></a>Basic Access</h5>
<div class="paragraph">
<p>The basic access syntax is quite similar to accessing an object&#8217;s attributes in JavaScript or Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Attributes of an object</strong> can be accessed by their key (<strong>key step</strong>) using the <em>dot notation</em> (<code>resource.key</code>) or the <em>bracket notation</em> (<code>resource["key"]</code>,<code>resource['key']</code>). Both expressions return the value of the specified attribute. For using the dot notation, the specified key must be an <a href="#identifiers">identifier</a>. Otherwise, the bracket notation with a string between square brackets is necessary, e.g., if the key contains whitespace characters (<code>resource['another key']</code>).</p>
</li>
<li>
<p><strong>Indices of an array</strong> may be accessed by putting the index between square brackets (<strong>index step</strong>, <code>array[3]</code>). The index can be a negative number <code>-n</code>, which evaluates to the <code>n</code>-th element from the end of the array, starting with -1 as the last element&#8217;s index. <code>array[-2]</code> would return the second last element of the array <code>array</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple selection steps can be <strong>chained</strong>. The steps are evaluated from left to right. Each step is applied to the result returned from the previous step.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>The expression <code>object.array[2]</code> first selects the attribute with key <code>array</code> from the object <code>object</code> (first step). Then it returns the third element (index <code>2</code>) of that array (second step).</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="extended-possibilities"><a class="anchor" href="#extended-possibilities"></a>Extended Possibilities</h5>
<div class="paragraph">
<p>SAPL supports querying for specific parts of a JSON structure. Except for an <strong>expression step</strong>, all of these steps return an array since the number of elements found can vary. Even if only a single result is retrieved, the expression returns an array containing one item.</p>
</div>
<div class="sect5">
<h6 id="expression-step-expression"><a class="anchor" href="#expression-step-expression"></a>Expression Step <code>[(Expression)]</code></h6>
<div class="paragraph">
<p>An expression step returns the value of an attribute with a key or an array item with an index specified by an expression. <code>Expression</code> must evaluate to a string or a number. If <code>Expression</code> evaluates to a string, the selection can only be applied to an object. If <code>Expression</code> evaluates to a number, the selection can only be applied to an array.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The expression step can be used to refer to custom variables (<code>object.array[(anIndex+2)]</code>) or apply custom functions (<code>object.array[(max_value(object.array))]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="wildcard-step-or"><a class="anchor" href="#wildcard-step-or"></a>Wildcard Step <code>.*</code> or <code>[*]</code></h6>
<div class="paragraph">
<p>A wildcard step can be applied to an object or an array. When applied to an object, it returns an array containing all attribute values. As attributes of an object have no order, the sorting of the result is not defined. When applied to an array, the step just leaves the array untouched.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to an object <code>{"key1":"value1", "key2":"value2"}</code>, the selection step <code>.*</code> or <code>[*]</code> returns the following array: <code>["value1", "value2"]</code> (possibly with a different sorting of the items).
Applied to an array <code>[1, 2, 3]</code>, the selection step <code>.<strong></code> or <code>[</strong>]</code> returns the original array <code>[1, 2, 3]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="recursive-descent-step-key-key-1-or"><a class="anchor" href="#recursive-descent-step-key-key-1-or"></a>Recursive Descent Step <code>..key</code>, <code>..["key"]</code>, <code>..[1]</code>, <code>..*</code> or <code>..[*]</code></h6>
<div class="paragraph">
<p>Looks for the specified key or array index in the current object or array and, recursively, in its children (i.e., the values of its attributes or its items). The recursive descent step can be applied to both an object and an array. It returns an array containing all attribute values or array items found. If the specified key is an asterisk (<code>..<strong></code> or <code>[</strong>]</code>, wildcard), all attribute values and array items in the whole structure are returned.</p>
</div>
<div class="paragraph">
<p>As attributes of an object are not sorted, the order of items in the result array may vary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Applied to an <code>object</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    "key" : "value1",
    "anotherkey" : {
        "key" : "value2"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The selection step <code>object..key</code> returns the following array: <code>["value1", "value2"]</code> (any attribute value with key <code>key</code>, the items may be in a different order).</p>
</div>
<div class="paragraph">
<p>The wildcard selection step <code>object..<strong></code> or <code>object..[</strong>]</code> returns <code>["value1", {"key":"value2"}, "value2"]</code> (recursively each attribute value and array item in the whole structure <code>object</code>, the sorting may be different).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="condition-condition"><a class="anchor" href="#condition-condition"></a>Condition <code>[?(Condition)]</code></h6>
<div class="paragraph">
<p>Condition steps return an array containing all attribute values or array items for which <code>Condition</code> evaluates to <code>true</code>. It can be applied to both an object (then it checks each attribute value) and an array (then it checks each item). <code>Condition</code> must be an expression in which <a href="#basic-relative">relative expressions</a> starting with <code>@</code> can be used. <code>@</code> evaluates to the current attribute value or array item for which the condition is evaluated and can be followed by further selection steps.</p>
</div>
<div class="paragraph">
<p>As attributes have no order, the sorting of the result array of a condition step applied to an object is not specified.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to the array <code>[1, 2, 3, 4, 5]</code>, the selection step <code>[?(@ &gt; 2)]</code> returns the array <code>[3, 4, 5]</code> (containing all values that are greater than 2).
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="array-slicing-startstopstep"><a class="anchor" href="#array-slicing-startstopstep"></a>Array Slicing <code>[Start:Stop:Step]</code></h6>
<div class="paragraph">
<p>The slice contains the items with indices between <code>Start</code> and <code>Stop</code>, with <code>Start</code> being inclusive and <code>Stop</code> being exclusive. <code>Step</code> describes the distance between the elements to be included in the slice, i.e., with a <code>Step</code> of 2, only each second element would be included (with <code>Start</code> as the first element&#8217;s index). All parts except the first colon are optional. <code>Step</code> defaults to 1.</p>
</div>
<div class="paragraph">
<p>In case <code>Step</code> is positive, <code>Start</code> defaults to 0 and <code>Stop</code> defaults to the length of the array. If <code>Step</code> is negative, <code>Start</code> defaults to the length of the array minus 1 (i.e., the last element&#8217;s index) and <code>Stop</code> defaults to -1. A <code>Step</code> of 0 leads to an error.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to the Array <code>[1, 2, 3, 4, 5]</code>, the selection step <code>[-2:]</code> returns the Array <code>[4, 5]</code> (the last two elements).
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If Start and Stop are to be left empty, the two colons must be separated by a whitespace to avoid confusion with the sub-template operator. So write <code>[: :-2]</code> instead of <code>[::-2]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="index-union-index1-index2"><a class="anchor" href="#index-union-index1-index2"></a>Index Union <code>[index1, index2, &#8230;&#8203;]</code></h6>
<div class="paragraph">
<p>By using the bracket notation, a set of multiple array indices (numbers) can be denoted separated by commas. This returns an array containing the items of the original array if the item&#8217;s index is contained in the specified indices. Since a <strong>set</strong> of indices is specified, the indices' order is ignored, and duplicate elements are removed. The result array contains the specified elements in their original order. Indices that do not exist in the original array are ignored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both <code>[3, 2, 2]</code> and <code>[2, 3]</code> return the same result.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="attribute-union-attribute1-attribute2"><a class="anchor" href="#attribute-union-attribute1-attribute2"></a>Attribute Union <code>["attribute1", "attribute2", &#8230;&#8203;]</code></h6>
<div class="paragraph">
<p>By using the bracket notation, a set of multiple attribute keys (strings) can be denoted separated by commas. This returns an array containing the values of the denoted attributes. Since a <strong>set</strong> of attribute keys is specified, the keys' order is ignored, and duplicate elements are removed. As attributes have no order, the sorting of the resulting array is not specified. Attributes that do not exist are ignored.</p>
</div>
</div>
<div class="sect5">
<h6 id="attribute-selection-on-array"><a class="anchor" href="#attribute-selection-on-array"></a>Attribute Selection on Array</h6>
<div class="paragraph">
<p>Although arrays do not have attributes (they have items), a key step can be applied to an array (e.g., <code>array.value</code>). This will loop through each item of the array and look for the specified attribute in this item. An array containing all values of the attributes found is returned. In other words, the selection step is not applied to the result of the previous step (the array) but to each item of the result, and the (sub-)results are concatenated. In case an array item is no object or does not contain the specified attribute, it is skipped.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Applied to an object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    "array":[
        {"key":"value1"},
        {"key":"value2"}
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>array.key</code> returns the following array: <code>["value1", "value2"]</code> (the value of the <code>key</code> attribute of each item of <code>array</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="attribute-finder-finder-name"><a class="anchor" href="#attribute-finder-finder-name"></a>Attribute Finder <code>.&lt;finder.name&gt;</code></h6>
<div class="paragraph">
<p>In SAPL, it is possible to receive attributes that are not contained in the authorization subscription. Those attributes can be provided by external PIPs and obtained through attribute finders.</p>
</div>
<div class="paragraph">
<p>The standard attributes in SAPL are intended to gather more information with regards to a given JSON value, i.e., the subject, action, resource, environment objects in the subscription, or any other JSON value.</p>
</div>
<div class="paragraph">
<p>A standard attribute finder is called via the selection step <code>.&lt;finder.name&gt;</code>. Where <code>finder.name</code> either is a fully qualified attribute finder name or can be a shorter name if imports are used (the finder name or the library alias followed by a period <code>.</code> and the finder name). Any number of selection steps can be appended after such a step.</p>
</div>
<div class="paragraph">
<p>An attribute accessed this way is treated as a subscription. I.e., the PDP will subscribe to the data source, and whenever a new value is returned, the policy is reevaluated, and a new decision is calculated.</p>
</div>
<div class="paragraph">
<p>The attribute finder receives the result of the previous selection as an argument and returns a JSON value. Optionally, an attribute finder may be supplied with a list of parameters: <code>.&lt;finder.name(p1,p2,&#8230;&#8203;)&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Attribute finders may be nested: <code>subject.&lt;finder.name2&gt;.&lt;finder.name(p1,action.&lt;finder.name3&gt;,&#8230;&#8203;)&gt;</code>. Here, whenever the attributes with <code>name2</code> and  <code>name3</code> all have an initial result, and whenever one of the results change, the attribute with name <code>name</code> is re-subscribed with the new input parameters.</p>
</div>
<div class="paragraph">
<p>An environment attribute finder is an attribute finder intended for accessing information possibly independent of subscription data, e.g., current time or an organization-wide emergency level. These environment attributes are not to be confused with the data which is contained in the environment object in the subscription. The data contained there is environment data provided by the PEP from its application context at subscription time and may not be accessible from the PDP otherwise. Environment attributes do not require a left-hand input and can be accessed without a leading value, variable, or sequence of selection steps: <code>&lt;organization.emergencyLevel&gt;</code> may refer to a stream indicating an emergency level in an organization. Analogous to standard attributes, these attributes may be parameterized and nested.</p>
</div>
<div class="paragraph">
<p>All attribute finders may be followed by arbitrary selection steps.</p>
</div>
<div class="paragraph">
<p>In some scenarios, it may not be the right thing to subscribe to attributes, but to just retrieve the data once on subscription time.
For this, SAPL offers the head operator for both standard and environment attributes. Prepending the pipe symbol <code>|</code> in front of an attribute finder step will only return the first value returned by the attribute finder. E.g.: <code>subject.id.|&lt;geo.location&gt;</code>. However, such an attribute may still return a stream if used with nested attributes which do not employ the head operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Assuming a doctor should only be allowed to access patient data from patients on her unit. The following expression retrieves the unit (attribute finder <code>pip.hospital_units.by_patientid</code>) by the requested patient id (<code>action.patientid</code>) and selects the id of the supervising doctor (<code>.doctorid</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>action.patientid.&lt;pip.hospital_units.by_patientid&gt;.doctorid</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Attribute finders are described in greater detail <a href="#attribute-finders">below</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filtering"><a class="anchor" href="#filtering"></a>Filtering</h4>
<div class="paragraph">
<p>SAPL provides syntax elements filtering values by applying <strong>filters</strong>, and that can potentially modify the value.</p>
</div>
<div class="paragraph">
<p>Filters can only be applied to basic expressions (remember that an expression in parentheses is a basic expression). Filtering is denoted by the <code>|-</code> operator after the expression. Which <strong>filter function</strong> is applied in what way can be defined by a <strong>simple filtering component</strong> or by an <strong>extended filtering component</strong>, which consists of several filter statements.</p>
</div>
<div class="sect4">
<h5 id="filter-functions"><a class="anchor" href="#filter-functions"></a>Filter Functions</h5>
<div class="paragraph">
<p>SAPL provides three <strong>built-in filter functions</strong>:</p>
</div>
<div class="paragraph">
<div class="title">remove</div>
<p>Removes a whole attribute (key and value pair) of an object or an item of an array without leaving a replacement.</p>
</div>
<div class="paragraph">
<div class="title">filter.replace(replacement)</div>
<p>Replaces an attribute or an element by the result of evaluating the expression <code>replacement</code>.</p>
</div>
<div class="paragraph">
<div class="title">filter.blacken(disclose\_left=0,disclose\_right=0,replacement="X")</div>
<p>Replaces each char of an attribute or item (which must be a string) by <code>replacement</code>, leaving <code>show\_left</code> chars from the beginning and <code>show\_right</code> chars from the end unchanged. By default, no chars are visible, and each char is replaced by <code>X</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>filter.blacken</code> could be used to reveal only the first digit of the credit card number and replace the other digits by <code>X</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>filter.replace</code> and <code>filter.blacken</code> are part of the library <code>filter</code>. Importing this library through <code>import filter</code> makes the functions available under their simple names.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>We take the following object:</p>
</div>
<div class="listingblock">
<div class="title">Object Structure</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    "value" : "aValue",
    "id" : 5
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>value</code> is <strong>removed</strong>, the resulting object is <code>{ "id" : 5 }</code>.</p>
</div>
<div class="paragraph">
<p>If instead <strong>filter.replace</strong> is applied to <code>value</code> with the Expression <code>null</code>, the resulting object is <code>{ "value" : null, "id" : 5 }</code>.</p>
</div>
<div class="paragraph">
<p>If the function <strong>filter.blacken</strong> is applied to <code>value</code> without specifying any arguments, the result would be <code>{ "value" : "XXXXXX", "id" : 5 }</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="simple-filtering"><a class="anchor" href="#simple-filtering"></a>Simple Filtering</h5>
<div class="paragraph">
<p>A simple filter component applies a <strong>filter function</strong> to the preceding value. The syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BasicExpression |- Function</pre>
</div>
</div>
<div class="paragraph">
<p><code>BasicExpression</code> is evaluated to a value, the function is applied to this value, and the result is returned. If no other arguments are passed to the function, the empty parentheses <code>()</code> after the function name can be omitted.</p>
</div>
<div class="paragraph">
<p>In case <code>BasicExpression</code> evaluates to an array, the whole array is passed to the filter function. The <strong>keyword <code>each</code></strong> before <code>Function</code> can be used to apply the function to each array item instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expression |- each Function</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume our resource contains an array of credit card numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    "numbers": [
        "1234123412341234",
        "2345234523452345",
        "3456345634563456"
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>blacken(1)</code> without any additional parameters takes a string and replaces everything by <code>X</code> except the first char. We can receive the blackened numbers through the basic expression <code>resource.numbers |- each blacken(1)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[
    "1XXXXXXXXXXXXXXX",
    "2XXXXXXXXXXXXXXX",
    "3XXXXXXXXXXXXXXX"
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the keyword <code>each</code>, the function <code>blacken</code> would be applied to the array itself, resulting in an error, as stated above, <code>blacken</code> can only be applied to a String.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="extended-filtering"><a class="anchor" href="#extended-filtering"></a>Extended Filtering</h5>
<div class="paragraph">
<p>Extended filtering can be used to state more precisely how a value should be altered.</p>
</div>
<div class="paragraph">
<p>E.g., the expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource |- { @.credit_card : blacken }</pre>
</div>
</div>
<div class="paragraph">
<p>would return the original resource except for the value of the attribute <code>credit_card</code> being blackened.</p>
</div>
<div class="paragraph">
<p>Extended filtering components consist of one or more <strong>filter statements</strong>. Each filter statement has a target expression and specifies a filter function that shall be applied to the attribute value (or to each of its items if the keyword <code>each</code> is used). The basic syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expression |- {
    FilterStatement,
    FilterStatement,
    ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>The syntax of a filter statement is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>each TargetRelativeExpression : Function</pre>
</div>
</div>
<div class="paragraph">
<p><code>each</code> is an optional keyword. If used, the <code>TargetRelativeExpression</code> must evaluate to an array. In this case, <code>Function</code> is applied to each item of that array.</p>
</div>
<div class="paragraph">
<p><code>TargetRelativeExpression</code> contains a basic relative expression starting with <code>@</code>. The character <code>@</code> references the result of the evaluation of <code>Expression</code>, so attributes of the value to filter can be accessed easily. Bear in mind that attribute finder steps are not allowed at this place. The value of the attribute selected by the target expression is replaced by the result of the filter function.</p>
</div>
<div class="paragraph">
<p>The filter statements are applied successively from top to bottom.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Some filter functions can be applied to both arrays and other types (e.g., <code>remove</code>). Yet, there are selection steps resulting in a "helper array" that cannot be modified. If, for instance, <code>.*</code> is applied to the object <code>{"key1" : "value1", "key2" : "value2"}</code>, the result would be <code>["value1", "value2"]</code>. It is not possible to apply a filter function directly to this array because changing the array itself would not have any effect. The array has been constructed merely to hold multiple values for further processing. In this case, the policy would <strong>have to</strong> use the keyword <code>each</code> and apply the function to each item. The attempt to alter a helper array will result in an error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="custom-filter-functions"><a class="anchor" href="#custom-filter-functions"></a>Custom Filter Functions</h5>
<div class="paragraph">
<p>Any function available in SAPL can be used in a filter statement. Hence it is easy to add custom filter functions.</p>
</div>
<div class="paragraph">
<p>When used in a filter statement, the value to filter is passed to the function as its first argument. Consequently, the arguments specified in the function call are passed as second, third, etc., arguments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Assuming a filter function <code>roundto</code> should round a value to the closest multiple of a given number, e.g., <code>207 |- roundto(100)</code> should return <code>200</code>. In its definition, the function needs two formal parameters. The first parameter is reserved for the original value and the second one for the number to round to.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="subtemplate"><a class="anchor" href="#subtemplate"></a>Subtemplate</h4>
<div class="paragraph">
<p>It is possible to define a subtemplate for an array to replace each item of the array with this subtemplate. A subtemplate component is an optional part of a basic expression.</p>
</div>
<div class="paragraph">
<p>E.g., the basic expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource.patients :: {
    "name" : @.name
}</pre>
</div>
</div>
<div class="paragraph">
<p>This expression would return the <code>patients</code> array from the resource but with each item containing only one attribute <code>name</code>.</p>
</div>
<div class="paragraph">
<p>The subtemplate is denoted after a double colon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Array :: Expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Expression</code> represents the replacement template. In this expression, basic relative expressions (starting with <code>@</code>) can be used to access the attributes of the current array item. <code>@</code> references the array item, which is currently being replaced. <code>Array</code> must evaluate to an array. For each item of <code>Array</code>, <code>Expression</code> is evaluated, and the item is replaced by the result.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>Given the variable <code>array</code> contains the following array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[
    { "id" : 1 },
    { "id" : 2 }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>array :: {
    "aKey" : "aValue"
    "identifier" : @.id
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>would evaluate to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[
    {"aKey" : "aValue", "identifier" : 1 },
    {"aKey" : "aValue", "identifier" : 2 }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization-subscription-evaluation"><a class="anchor" href="#authorization-subscription-evaluation"></a>Authorization Subscription Evaluation</h2>
<div class="sectionbody">
<div id="evaluation" class="paragraph">
<p>For any authorization subscription, the PDP evaluates each top-level SAPL document against the subscription and combines the decisions. If a top-level document is a policy set, it contains multiple policies which have to be evaluated first. Their decisions are combined to form an evaluation decision for the policy set. Finally, a resource might be added to the final result, as well as obligations and advice.</p>
</div>
<div class="paragraph">
<p>The underlying concept assumes that during evaluation, a decision is assigned to each document. This process will be explained in the following sections.</p>
</div>
<div class="sect2">
<h3 id="policy-2"><a class="anchor" href="#policy-2"></a>Policy</h3>
<div class="paragraph">
<p>Evaluating a policy against an authorization subscription means assigning a value of <code>NOT_APPLICABLE</code>, <code>INDETERMINATE</code>, <code>PERMIT</code>, or <code>DENY</code> to it. The assigned value depends on the result of evaluating the policy&#8217;s target and condition (which are conditions that can either be <code>true</code> or <code>false</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Policy Evaluation Table</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Target Expression</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Policy Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code> (not matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Policy&#8217;s <strong>Entitlement</strong> (<code>PERMIT</code> or <code>DENY</code>)</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="policy-set"><a class="anchor" href="#policy-set"></a>Policy Set</h3>
<div class="paragraph">
<p>A decision value (<code>NOT_APPLICABLE</code>, <code>INDETERMINATE</code>, <code>PERMIT</code> or <code>DENY</code>) can also be assigned to a policy set. This value depends on the result of evaluating the policy set&#8217;s target expression and the policies contained in the policy set:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Policy Set Evaluation Table</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Target Expression</th>
<th class="tableblock halign-left valign-top">Policy Values</th>
<th class="tableblock halign-left valign-top">Policy Set Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code> (not matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Result of the <strong>Combining Algorithm</strong> applied to the Policies</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="authorization-subscription"><a class="anchor" href="#authorization-subscription"></a>Authorization Subscription</h3>
<div class="paragraph">
<p>The value, which is assigned to the authorization subscription, i.e., the final authorization decision to be returned by the PDP, is the result of applying a combining algorithm to the values assigned to all top-level SAPL documents.</p>
</div>
<div class="paragraph">
<p>Finally, in case the decision is <code>PERMIT</code>, and there is a <code>transform</code> statement, the transformed resource is added to the authorization decision. Additionally, there might be an obligation and advice contained in the policies which have to be added to the authorization decision.</p>
</div>
</div>
<div class="sect2">
<h3 id="combining-algorithm-2"><a class="anchor" href="#combining-algorithm-2"></a>Combining Algorithm</h3>
<div id="combining-algorithms" class="paragraph">
<p>There are two layers with possibly multiple decisions that finally need to be consolidated into a single decision:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A policy set might contain multiple policies evaluating to different decisions. There must be a final decision for the policy set (<em>Policy Combination</em>).</p>
</li>
<li>
<p>The PDP might know multiple policy sets and policies which may evaluate to different decisions. In the end, the PDP must include a final decision in the SAPL authorization decision (<em>Document Combination</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A combining algorithm describes how to come to the final decision. Both the PDP itself and each policy set must be configured with a combining algorithm.</p>
</div>
<div class="paragraph">
<p>Some complexity is added to the algorithms if transformation statements in policies are used: There is no possibility to combine multiple transformation statements. Hence the combining algorithms have to deal with the situation that multiple policies evaluate to <code>PERMIT</code>, and at least one of them contains a transformation part. In case of such <em>transformation uncertainty</em>, the decision must not be <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>SAPL provides the following combining algorithms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
<li>
<p><code>first-applicable</code> (not allowed on PDP level for document combination)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The algorithms work similarly on the PDP and on the policy set level. Thus the following section describes their function in general, using the term <em>policy document</em> for a policy and a policy set. If the algorithm is used on the PDP level, a <em>policy document</em> could be either a (top-level) policy or a policy set. On the policy set level, a <em>policy document</em> is always a policy.</p>
</div>
<div class="sect3">
<h4 id="deny-unless-permit"><a class="anchor" href="#deny-unless-permit"></a><code>deny-unless-permit</code></h4>
<div class="paragraph">
<p>This strict algorithm is used if the decision should be <code>DENY</code> except for there is a <code>PERMIT</code>. It ensures that any decision is either <code>DENY</code> or <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>PERMIT</code> and there is no <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise, the decision is <code>DENY</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="permit-unless-deny"><a class="anchor" href="#permit-unless-deny"></a><code>permit-unless-deny</code></h4>
<div class="paragraph">
<p>This generous algorithm is used if the decision should be <code>PERMIT</code> except for there is a <code>DENY</code>. It ensures that any decision is either <code>DENY</code> or <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>DENY</code> or if there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise, the decision is <code>PERMIT</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="only-one-applicable"><a class="anchor" href="#only-one-applicable"></a><code>only-one-applicable</code></h4>
<div class="paragraph">
<p>This algorithm is used if policy sets, and policies are constructed in a way that multiple policy documents with a matching target are considered an error. A <code>PERMIT</code> or <code>DENY</code> decision will only be returned if there is exactly one policy set or policy with matching target expression and if this policy document evaluates to <code>PERMIT</code> or <code>DENY</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any target evaluation results in an error (<code>INDETERMINATE</code>) or if more than one policy documents have a matching target, the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise (i.e., only one policy document with matching target, no errors):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is no matching policy document, the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
<li>
<p>Otherwise (i.e., there is exactly one matching policy document), the decision is the result of evaluating this policy document.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Transformation uncertainty cannot occur using the <code>only-one-applicable</code> combining algorithm.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="deny-overrides"><a class="anchor" href="#deny-overrides"></a><code>deny-overrides</code></h4>
<div class="paragraph">
<p>This algorithm is used if a <code>DENY</code> decision should prevail a <code>PERMIT</code> without setting a default decision.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>DENY</code>, the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise (no policy document evaluates to <code>DENY</code>):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is any <code>INDETERMINATE</code> or there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code>, and at least one of them has a transformation statement), the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise (no policy document evaluates to <code>DENY</code>, no policy document evaluates to <code>INDETERMINATE</code>, no transform uncertainty):</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If there is at least one <code>PERMIT</code>, the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise, the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="permit-overrides"><a class="anchor" href="#permit-overrides"></a><code>permit-overrides</code></h4>
<div class="paragraph">
<p>This algorithm is used if a <code>PERMIT</code> decision should prevail any <code>DENY</code> without setting a default decision.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>PERMIT</code> and there is no <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise (no policy document evaluates to <code>DENY</code>):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is any <code>INDETERMINATE</code> or there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code>, and at least one of them has a transformation statement), the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise (no policy document evaluates to <code>DENY</code>, no policy document evaluates to <code>INDETERMINATE</code>, no transform uncertainty):</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If there is any <code>DENY</code>, the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise, the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="first-applicable"><a class="anchor" href="#first-applicable"></a><code>first-applicable</code></h4>
<div class="paragraph">
<p>This algorithm is used if the policy administrator manages the policy&#8217;s priority by their order in a policy set. As soon as the first policy returns <code>PERMIT</code>, <code>DENY</code>, or <code>INDETERMINATE</code>, its result is the final decision. Thus a "default" can be specified by creating a last policy without any conditions. If a decision is found, errors that might occur in later policies are ignored.</p>
</div>
<div class="paragraph">
<p>Since there is no order in the policy documents known to the PDP, the PDP cannot be configured with this algorithm. <code>first-applicable</code> might only be used for policy combination inside a policy set.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each policy is evaluated in the order specified in the policy set.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it evaluates to <code>INDETERMINATE</code>, the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>If it evaluates to <code>PERMIT</code> or <code>DENY</code>, the decision is <code>PERMIT</code> or <code>DENY</code></p>
</li>
<li>
<p>If it evaluates to <code>NOT_APPLICABLE</code>, the next policy is evaluated.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If no policy with a decision different from <code>NOT_APPLICABLE</code> has been found, the decision of the policy set is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transformation-2"><a class="anchor" href="#transformation-2"></a>Transformation</h3>
<div class="paragraph">
<p>A policy with an entitlement <code>permit</code> can contain a transformation statement. If the decision is <code>PERMIT</code> and there is a policy evaluating to <code>PERMIT</code> with transformation, the result of evaluating the expression after the keyword <code>transform</code> is returned as the <code>resource</code> in the authorization decision.</p>
</div>
<div class="paragraph">
<p>The combining algorithms ensure that transformation is always unambiguous. Consequently, there either is exactly one transformation or none.</p>
</div>
</div>
<div class="sect2">
<h3 id="obligation-advice"><a class="anchor" href="#obligation-advice"></a>Obligation / Advice</h3>
<div class="paragraph">
<p>Finally, obligation and advice might be added to the authorization decision. Both can be defined for each policy individually. If a final decision is <code>PERMIT</code>, there can be multiple policies and policy sets evaluating to <code>PERMIT</code>, each of them containing an obligation and/or advice statement - same goes for <code>DENY</code>. The final authorization decision with a certain decision must contain all obligations and advice of policy documents evaluating to this decision, but not the obligation and advice of those policy documents evaluating to a different decision.</p>
</div>
<div class="paragraph">
<p>On the two levels (PDP and policy set), collection of obligation and advice works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Policy Set</strong>: If the policy set evaluates to a certain decision (<code>PERMIT</code> or <code>DENY</code>), the obligation and advice from all contained policies evaluating to this decision are bundled as the obligation and advice of the policy set.</p>
<div class="paragraph">
<p>(For the combining algorithm <code>first-applicable</code>, not all policies might be evaluated. A value <code>PERMIT</code> or <code>DENY</code> is only assigned to evaluated policies. Thus, the policy set&#8217;s obligation and advice do only contain obligations and advice from evaluated policies.)</p>
</div>
</li>
<li>
<p><strong>PDP</strong>: If the final decision is <code>PERMIT</code> or <code>DENY</code>, the obligation and advice from all top-level policy documents evaluating to this final decision are collected as the final decision&#8217;s obligation and advice.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functions"><a class="anchor" href="#functions"></a>Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functions can be used within SAPL expressions (basic function expressions). A function takes some inputs (called <em>arguments</em>) and returns an output value.</p>
</div>
<div class="paragraph">
<p>Functions are organized in function libraries. Each function library has a <em>name</em> consisting of one or more identifiers separated by periods <code>.</code> (e.g., <code>simple.string</code> or <code>filter</code>). The <em>fully qualified name</em> of a function consists of the library name followed by a period and the function name (e.g., <code>simple.string.append</code>).</p>
</div>
<div class="paragraph">
<p>Functions can be used in any part of a SAPL document, especially in the target expression. Therefore, their output should only depend on the input arguments, and they should not access external resources. Functions do not have access to environment variables.</p>
</div>
<div class="paragraph">
<p>SAPL ships with a standard function library providing some basic functions.</p>
</div>
<div class="sect2">
<h3 id="custom-function-libraries"><a class="anchor" href="#custom-function-libraries"></a>Custom Function Libraries</h3>
<div class="paragraph">
<p>For a more in-depth look at the process of creating a custom function library, please refer to the demo project. It provides a walkthrough of the entire process and contains extensive examples: <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-extension" class="bare">https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-extension</a> .</p>
</div>
<div class="paragraph">
<p>The standard functions can be extended by custom functions. Function libraries available in SAPL documents are collected in the PDP&#8217;s function context. The embedded PDP provides an <code>AnnotationFunctionContext</code> where Java classes with annotations can be provided as function libraries:</p>
</div>
<div class="paragraph">
<p>SAPL functions must not perform any IO operations. Functions are to be used as "immediate" data transformation functions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To be recognized as a function library, a class must be annotated with <code>@FunctionLibrary</code>. The optional annotation attribute <code>name</code> contains the library&#8217;s name as it will be available in SAPL policies. The attribute value must be a string consisting of one or more identifiers separated by periods. If the attribute is missing, the name of the Java class is used. The optional annotation attribute <code>description</code> contains a string describing the library for documentation purposes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@FunctionLibrary(name = "sample.functions", description = "a sample library")
public class SampleFunctionLibrary {
    ...
}</code></pre>
</div>
</div>
</li>
<li>
<p>The annotation <code>@Function</code> identifies a function in the library. An optional annotation attribute <code>name</code> can contain a function name. The attribute is a string containing an identifier. By default, the name of the Java function will be used. The annotation attribute <code>docs</code> can contain a string describing the function.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Function(docs = "returns the length")
public static Val length(@Text Val parameter) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each parameter can be annotated with any number of <code>@Array</code>, <code>@Bool</code>, <code>@Int</code>, <code>@JsonObject</code>, <code>@Long</code>, <code>@Number</code>, and <code>@Text</code>. The annotations describe which types are allowed for the parameter (in the case of multiple annotations, each of these types is allowed).</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="attribute-finders"><a class="anchor" href="#attribute-finders"></a>Attribute Finders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Attribute finders are used to receive attributes that are not included in the authorization subscription context from external PIPs. Just like in <code>subject.age</code>, the selection step <code>.age</code> selects the attribute <code>age</code>s value, <code>subject.&lt;user.age&gt;</code> could be used to fetch an <code>age</code> attribute which is not included in the <code>subject</code> but can be obtained from a PIP named <code>user</code>.</p>
</div>
<div class="paragraph">
<p>Attribute finders are organized in libraries as well and follow the same naming conventions as functions, including the use of imports. An attribute finder library constitutes a PIP (e.g., <code>user</code>) and can contain any number of attributes (e.g., <code>age</code>). They are called by a selection step applied to any value, e.g., <code>subject.&lt;user.age&gt;</code>. The attribute finder step receives the previous selection result (in the example: <code>subject</code>) and returns the requested attribute.</p>
</div>
<div class="paragraph">
<p>The concept of attribute finders can be used in a flexible manner: There may be finders that take an object (like in the example above, <code>subject.&lt;user.age&gt;</code>) as well as attribute finders which expect a primitive value (e.g., <code>subject.id.&lt;user.age&gt;</code> with <code>id</code> being a number). In addition, attribute finders may also return an object which can be traversed in subsequent selection steps (e.g., <code>subject.&lt;user.profile&gt;.age</code>). It is even possible to join multiple attribute finder steps in one expression (e.g., <code>subject.&lt;user.profile&gt;.supervisor.&lt;user.profile&gt;.age</code>).</p>
</div>
<div class="paragraph">
<p>Optionally, an attribute finder may be supplied with a list of parameters: <code>x.&lt;finder.name(p1,p2,&#8230;&#8203;)&gt;</code>. Also, here nesting is possible. Thus <code>x.&lt;finder.name(p1.&lt;finder.name2&gt;,p2,&#8230;&#8203;)&gt;</code> is a working construct.</p>
</div>
<div class="paragraph">
<p>Furthermore, attribute finders may be used without any leading value <code>&lt;finder.name(p1,p2,&#8230;&#8203;)&gt;</code>. These are called environment attributes.</p>
</div>
<div class="paragraph">
<p>The way to read a statement with an attribute finder is as follows. For <code>subject.&lt;groups.membership("studygroup")&gt;</code> one would say "get the attribute <code>group.membership</code> with parameter <code>"studygroup"</code> of the subject".</p>
</div>
<div class="paragraph">
<p>Attribute finders often receive information from external data sources such as files, databases, or HTTP requests which may take a certain amount of time. Therefore, they must not be used in a target expression. Attribute finders can access environment variables.</p>
</div>
<div class="sect2">
<h3 id="custom-attribute-finders"><a class="anchor" href="#custom-attribute-finders"></a>Custom Attribute Finders</h3>
<div class="paragraph">
<p>For a more in-depth look at the process of creating a custom PIP, please refer to the demo project. It provides a walkthrough of the entire process and contains extensive examples: <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-extension" class="bare">https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-extension</a> .</p>
</div>
<div class="paragraph">
<p><strong>Attribute finders</strong> are functions that potentially take a left-hand argument (i.e., the object of which the attribute is to be determined), a <code>Map</code> of variables defined in the current evaluation scope, and an optional list of incoming parameter streams.</p>
</div>
<div class="paragraph">
<p>In SAPL, a Policy Information Point is an instance of a class that supplies a set of such functions. To declare functions and classes to be attributes or PIPs, SAPL uses annotations. Each PIP class must be known to the PDP. The embedded PDP provides an <code>AnnotationAttributeContext</code>,  which takes arbitrary Java objects as PIPs. To be recognized as a PIP, the respective class must be annotated with <code>@PolicyInformationPoint</code>. The optional annotation attribute <code>name</code> contains the PIP&#8217;s name as it will be available in SAPL policies. If the attribute is missing, the name of the Java class is used. The optional annotation attribute <code>description</code> contains a string describing the PIP for documentation purposes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@PolicyInformationPoint(name = "user", description = "This the documentation of the PIP")
public class SampleUserPIP {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The individual attributes supplied by the PIP are identified by adding the annotation <code>@Attribute</code>. An optional annotation attribute <code>name</code> can contain a name for the attribute. The attribute must be a string containing an identifier. By default, the name of the function will be used. The annotation attribute <code>docs</code> can contain a string describing the attribute.</p>
</div>
<div class="paragraph">
<p>SAPL allows for attribute name overloading. This means that can be multiple implementations for resolving an attribute with one name. For example, you could implement, an environment attribute (<code>&lt;some.attribute&gt;</code>), a regular attribute (<code>"UTC".&lt;some.attribute&gt;</code>), both with parameters (<code>&lt;some.attribute("UTC")&gt;</code>, <code>"UTC.&lt;some.attribute(5000)&gt;</code>), and maybe even with a variable number of arguments (<code>&lt;some.attribute&gt;("a","b","c","d",123,4)</code>).</p>
</div>
<div class="paragraph">
<p>For an attribute of some other object, this object is called the left-hand parameter of the attribute. When writing a method implementing an attribute that takes a left-hand parameter, this parameter must be the first parameter of the method, and it must be of type <code>Val</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* subject.&lt;user.attribute&gt; */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(@Object Val leftHandObjectOfTheAttribute) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Input parameters of the method may be annotated with type validation annotations (see module <code>sapl-extension-api</code>, package <code>io.sapl.api.validation</code>). When present, the policy engine validates the contents of the parameters before calling the method.  Therefore, if present, the method does not need to perform additional type validation. The method will only be called if the left-hand parameter is a JSON Object in the example above. While different parameter types can be used to disambiguate overloaded methods in languages like Java, this is not possible in SAPL.</p>
</div>
<div class="paragraph">
<p>A typical use-case for attribute finder is retrieving attribute data from an external data source. If this is a network service like an API or database, the attribute finder usually must know the network address and credentials to authenticate with the service. Such data should never be hardcoded in the PIP. Also, developers should never store this data in policies. In SAPL, developers should store this information and further configuration data for PIPs in the environment variables. For the SAPL Server LT these variables are stored in the pdp.json configuration file, and for the SAPL Server CE they can be edited via the UI.</p>
</div>
<div class="paragraph">
<p>To access the environment variables, attribute finder methods can consume a Map&lt;String,JsonNode&gt;. The PDP will inject this map at runtime. The map contains all variables available in the current evaluation scope. This map must be the first parameter of the left-hand parameter, or it must be the first parameter for environment attributes. Note that attempting to overload an attribute name with and without variables as a parameter that accept the same number of other parameters will fail. The engine cannot disambiguate these two attributes at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* subject.&lt;user.attribute&gt; definition would clash with last example if defined at the same time in the same PIP*/
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(@Object Val leftHandObjectOfTheAttribute, Map&lt;String,JsonNode&gt; variables) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define environment attributes, i.e., attributes without left-hand parameters, the method definition explicitly does not define a <code>Val</code> parameter as its first parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* &lt;user.attribute&gt; */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute() {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, the environment attribute can consume variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* &lt;user.attribute&gt; definition would clash with last example if defined at the same time in the same PIP */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(Map&lt;String,JsonNode&gt; variables) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A unique feature of SAPL is the possibility to parameterize attribute finders in polices. E.g., <code>subject.&lt;employees.qualificationOfType("IT")&gt;</code> could return all qualifications of the subject in the domain of <code>"IT"</code>. Syntactically, SAPL also allows for the concatenation (<code>subject.&lt;pip1.attr1&gt;.&lt;pip2.attr2&gt;</code>) and nesting of attribute (<code>subject.&lt;pip1.attr1(resource.&lt;pip2.attr2&gt;,&lt;pip3.attr3&gt;)&gt;</code>).</p>
</div>
<div class="paragraph">
<p>Regardless of if the attribute is an environment attribute or not, the parameters in brackets are declared as parameters of the method with the type <code>Flux&lt;Val&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* subject.&lt;user.attribute("param1",123)&gt; */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(@Object Val leftHandObjectOfTheAttribute, Map&lt;String,JsonNode&gt; variables, @Text Flux&lt;Val&gt; param1, @Number Flux&lt;Val&gt; param2) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, using Java variable argument lists, it is possible to declare attributes with a variable number of attributes. If a method wants to use variable arguments, the method must not declare any other parameters besides the optional left-hand or variables parameters. If an attribute is overloaded, an implementation with an exact match of the number of arguments takes precedence over a variable arguments implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* subject.&lt;user.attribute("AA","BB","CC")&gt; */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(@Object Val leftHandObjectOfTheAttribute, Map&lt;String,JsonNode&gt; variables, @Text Flux&lt;Val&gt;... params) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively defining the variable arguments can be defined as an array.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/* &lt;user.attribute("AA","BB","CC")&gt; */
@Attribute(name = "attribute", docs = "documentation")
public Flux&lt;Val&gt; attribute(@Text Flux&lt;Val&gt;[] params) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The methods must not declare any further arguments.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Developers must add  <code>-parameters</code> parameter to the compilation to ensure that the automatically generated documentation does contain the names of the parameters used in the methods.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-sapl-policies"><a class="anchor" href="#testing-sapl-policies"></a>Testing SAPL policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The SAPL policy engine provides a framework to test SAPL policies. This framework supports unit tests of a single SAPL document or policy integration tests of all SAPL policies of an application via the PDP interface.</p>
</div>
<div class="sect2">
<h3 id="usage-scenarios"><a class="anchor" href="#usage-scenarios"></a>Usage scenarios</h3>
<div class="paragraph">
<p>With the SAPL test framework, developers can test SAPL policies whether they use SAPL via an embedded PDP in an application or via a central SAPL server.</p>
</div>
<div class="sect3">
<h4 id="embedded-pdp-2"><a class="anchor" href="#embedded-pdp-2"></a>Embedded PDP</h4>
<div class="paragraph">
<p>If an application uses an embedded PDP, SAPL policy tests are treated like traditional unit and integration tests. Developers can deploy policy tests alongside these tests and execute them identically via the Maven lifecycle on a local workstation or in a CI pipeline.</p>
</div>
</div>
<div class="sect3">
<h4 id="sapl-server"><a class="anchor" href="#sapl-server"></a>SAPL-Server</h4>
<div class="paragraph">
<p>The following repository <a href="https://github.com/heutelbeck/sapl-server-lt-gitops-example">GitOps Demo</a> showcases a deployment pipeline with SAPL policy tests in a <a href="https://www.weave.works/blog/gitops-operations-by-pull-request">GitOps</a>-Style for the headless SAPL-Server-LT.
Here every change to the policies is introduced via a pull request on the main branch. The CI pipeline executes the policy tests for every pull request and breaks the pipeline run if policy tests are failing.
Merging a pull request on the main branch triggers automatic synchronization of the policies to a SAPL-Server-LT instance.</p>
</div>
<div class="paragraph">
<p>SAPL tests use Java. Therefore, it is impossible to use the SAPL test framework when deploying SAPL-Server-Implementations with GUI-based PAP (i.e., SAPL-Server-CE or SAPL-Server-EE).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unit-tests"><a class="anchor" href="#unit-tests"></a>Unit-Tests</h3>
<div class="paragraph">
<p>SAPL tests use JUnit for executing SAPL unit test cases. Each test is prepared by creating <code>SaplUnitTestFixture</code>. This can be done in the  <code>@BeforeEachStep</code> of a JUnit test case.</p>
</div>
<div class="paragraph">
<p>The <code>SaplUnitTestFixture</code> defines the name of the SAPL document under test or the path to its file.
In addition, the fixture sets up PIPs and FunctionLibrarys to be used during test execution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    private SaplTestFixture fixture;

    @BeforeEach
    void setUp() throws InitializationException {
        fixture = new SaplUnitTestFixture("policyStreaming")
                //.registerPIP(...)
                .registerFunctionLibrary(new TemporalFunctionLibrary());
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="policy-integration-tests"><a class="anchor" href="#policy-integration-tests"></a>Policy-Integration-Tests</h3>
<div class="paragraph">
<p>Instead of testing a single SAPL document, all policies can be tested together using the PDP interface, just like when an application uses an embedded PDP or a SAPL server.</p>
</div>
<div class="paragraph">
<p>The <code>SaplIntegrationTestFixture</code> manages these kinds of integrations tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    private SaplTestFixture fixture;

    @BeforeEach
    void setUp() {
        fixture = new SaplIntegrationTestFixture("policiesIT")
            .withPDPPolicyCombiningAlgorithm(
                PolicyDocumentCombiningAlgorithm.PERMIT_UNLESS_DENY
            );
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="writing-test-cases"><a class="anchor" href="#writing-test-cases"></a>Writing test cases</h3>
<div class="paragraph">
<p>The Step-Builder-Pattern is used for defining the concrete test case. It consists of the following four steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Given-Step: Define mocks for attributes and functions</p>
</li>
<li>
<p>When-Step: Specify the <code>AuthorizationSubscription</code></p>
</li>
<li>
<p>Expect-Step: Define expectations for generated <code>AuthorizationDecision</code></p>
</li>
<li>
<p>Verify-Step: Verify the generated <code>AuthorizationDecision</code></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/StepBuilderPatternForSaplTest_English.svg" alt="Step Builder Pattern">
</div>
</div>
<div class="paragraph">
<p>Starting with constructTestCaseWithMocks() or constructTestCase() called on the fixture, the test case definition process is started at the Given-Step or the When-Step.</p>
</div>
<div class="sect3">
<h4 id="given-step"><a class="anchor" href="#given-step"></a>Given-Step</h4>
<div class="paragraph">
<p><strong>Mocking of functions</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>givenFunction</code> methods can be used to mock a function returning a <code>Val</code> specified in the method parameters for every call.</p>
<div class="ulist">
<ul>
<li>
<p>a single value can be specified</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunction("time.dayOfWeek", Val.of("SATURDAY"))</code></pre>
</div>
</div>
</li>
<li>
<p>a single value only returned when the parameters of the function call match some expectations</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunction("corp.subjectConverter",
    whenFunctionParams(is(Val.of("USER")), is(Val.of("nikolai"))), Val.of("ROLE_ADMIN"))</code></pre>
</div>
</div>
</li>
<li>
<p>or a Lambda-Expression evaluating the parameters of the function call</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunction("company.complexFunction", (FunctionCall call) -&gt; {

    //probably one should check for number and type of parameters first
    Double param0 = call.getArgument(0).get().asDouble();
    Double param1 = call.getArgument(1).get().asDouble();

    return param0 % param1 == 0 ? Val.of(true) : Val.of(false);
})</code></pre>
</div>
</div>
</li>
<li>
<p>and verify the number of calls to this mock</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunction("time.dayOfWeek", Val.of("SATURDAY"), times(1))</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>givenFunctionOnce</code> can specify a <code>Val</code> or multiple <code>Val</code>-Objects which are emitted once (in a sequence) when this mocked function is called</p>
<div class="ulist">
<ul>
<li>
<p>a single value</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunctionOnce("time.secondOf", Val.of(4))
.givenFunctionOnce("time.secondOf", Val.of(5))</code></pre>
</div>
</div>
</li>
<li>
<p>or a sequence of values</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenFunctionOnce("time.secondOf", Val.of(3), Val.of(4), Val.of(5))</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Mocking of attributes</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>givenAttribute</code> methods can mock attributes</p>
<div class="ulist">
<ul>
<li>
<p>to return one or more <code>Val</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenAttribute("time.now", timestamp0, timestamp1, timestamp2)</code></pre>
</div>
</div>
</li>
<li>
<p>to return a sequence of <code>Val</code> in an interval of <code>Duration</code>. Using <code>withVirtualTime</code> activates the virtual time feature of Project Reactor</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.withVirtualTime()
.givenAttribute("time.now", Duration.ofSeconds(10), timestamp0, timestamp1, timestamp2, timestamp3, timestamp4, timestamp5)</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The virtual time feature can be used with real time-based PIPs registered the fixture level. Virtual time is "no silver bullet" to cite the <a href="https://projectreactor.io/docs/core/release/reference/#_manipulating_time">Project Reactor Reference Guide</a>. It says further that "[v]irtual time also gets very limited with infinite sequences, which might hog the thread on which both the sequence and its verification run."
</td>
</tr>
</table>
</div>
</li>
<li>
<p>to mark an attribute to be mocked and specify return values in a sequence next to expectations</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenAttribute("company.pip1")
.givenAttribute("company.pip2")
.when(AuthorizationSubscription.of("User1", "read", "heartBeatData"))
.thenAttribute("company.pip1", Val.of(1))
.thenAttribute("company.pip2", Val.of("foo"))
.expectNextPermit()
.thenAttribute("company.pip2", Val.of("bar"))
.expectNextNotApplicable()</code></pre>
</div>
</div>
</li>
<li>
<p>to mock an attribute depending on the parent value</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenAttribute("test.upper", whenParentValue(val("willi")), thenReturn(Val.of("WILLI")))</code></pre>
</div>
</div>
</li>
<li>
<p>to mock an attribute depending on the parent value and every value the arguments are called for</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.givenAttribute("pip.attributeWithParams", whenAttributeParams(parentValue(val(true)), arguments(val(2), val(2))), thenReturn(Val.of(true)))</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further mock types or overloaded methods are available <a href="https://github.com/heutelbeck/sapl-policy-engine/blob/master/sapl-test/src/main/java/io/sapl/test/steps/GivenStep.java">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="when-step"><a class="anchor" href="#when-step"></a>When-Step</h4>
<div class="paragraph">
<p>The next defines the <code>AuthorizationSubscription</code> for the policy evaluation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pass an <code>AuthorizationSubscription</code> created by it&#8217;s factory methods</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.when(AuthorizationSubscription.of("willi", "read", "something"))</code></pre>
</div>
</div>
</li>
<li>
<p>pass a JSON-String to be parsed to an <code>AuthorizationSubscription</code> via the framework</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.when("{\"subject\":\"willi\", \"action\":\"read\", \"resource\":\"something\", \"environment\":{}}")</code></pre>
</div>
</div>
</li>
<li>
<p>pass a <code>JsonNode</code> object of the Jackson-Framework (<a href="https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/JsonNode.html">Reference</a>)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JsonNode authzSub = mapper.createObjectNode()
    .put("subject", "willi")
    .put("action", "read")
    .put("resource", "something")
    .put("environment", "test");
...
    .when(authzSub)</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="expect-step"><a class="anchor" href="#expect-step"></a>Expect-Step</h4>
<div class="paragraph">
<p>This step defines the expected <code>AuthorizationDecision</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>check only the Decision via</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.expectPermit()
.expectDeny()
.expectIndeterminate()
.expectNotApplicable()</code></pre>
</div>
</div>
</li>
<li>
<p>pass a <code>AuthorizationDecision</code> object to be checked for equality</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ObjectNode obligation = mapper.createObjectNode();
obligation.put("type", "logAccess");
obligation.put("message", "Willi has accessed patient data (id=56) as an administrator.");
ArrayNode obligations = mapper.createArrayNode();
obligations.add(obligation);

AuthorizationDecision decision = new AuthorizationDecision(Decision.PERMIT).withObligations(obligations);

...

    .expect(decision)</code></pre>
</div>
</div>
</li>
<li>
<p>use a predicate function to manually define checks</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.expect((AuthorizationDecision dec) -&gt; {
    // some complex and custom assertions
    if(dec.getObligations().isEmpty()) {
        return true;
    }
    return false;
})</code></pre>
</div>
</div>
</li>
<li>
<p>Hamcrest matchers provided by the sapl-hamcrest module can be used to express complex expectations on the decision, obligations, advice or resources of the <code>AuthorizationDecision</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.expect(
    allOf(
        isPermit(),
        hasObligationContainingKeyValue("type", "logAccess"),
        isResourceMatching((JsonNode resource) -&gt; resource.get("id").asText().equals("56"))
        ...
    )
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>All available <code>Matcher&lt;AuthorizationDecision&gt;</code> can be found <a href="https://github.com/heutelbeck/sapl-policy-engine/blob/master/sapl-hamcrest/src/main/java/io/sapl/hamcrest/Matchers.java">here</a></p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>These methods come with additional methods (e.g., <code>expectNextPermit</code>) to define multiple expectations for testing stream-based policies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">.expectNextPermit(3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>More available methods are documented <a href="https://github.com/heutelbeck/sapl-policy-engine/blob/master/sapl-test/src/main/java/io/sapl/test/steps/ExpectStep.jav">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="verify-step"><a class="anchor" href="#verify-step"></a>Verify-Step</h4>
<div class="paragraph">
<p>The <code>verify()</code> method completes the test definition, and triggers the evaluation of the policy/policies and verifies the expectations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="examples"><a class="anchor" href="#examples"></a>Examples</h3>
<div class="paragraph">
<p>The following example constitutes a full minimal SAPL unit test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class B_PolicyWithSimpleFunctionTest {

    private SaplTestFixture fixture;

    @BeforeEach
    void setUp() {
        fixture = new SaplUnitTestFixture("policyWithSimpleFunction.sapl");
    }

    @Test
    void test() {
        fixture.constructTestCaseWithMocks()
                .givenFunction("time.dayOfWeek", Val.of("SATURDAY"), times(1))
                .when(AuthorizationSubscription.of("willi", "read", "something"))
                .expectPermit()
                .verify();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A lot of additional examples showcasing the various features of this SAPL test framework can be found in the demo project <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-testing/src/test/java/io/sapl/test">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="code-coverage-reports-via-the-sapl-maven-plugin"><a class="anchor" href="#code-coverage-reports-via-the-sapl-maven-plugin"></a>Code-Coverage Reports via the SAPL-Maven-Plugin</h3>
<div class="paragraph">
<p>For measuring the policy code coverage of SAPL policies, developers can use the sapl-maven-plugin to analyze the coverage and generate reports in various formats.</p>
</div>
<div class="paragraph">
<p>Currently, three coverage criteria are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PolicySet Hit Coverage</strong>: Measures the percentage of PolicySets that were at least once applicable to an <code>AuthorizationSubscription</code> in the tests.</p>
</li>
<li>
<p><strong>Policy Hit Coverage</strong>: Measures the percentage of Policies that were at least once applicable to an <code>AuthorizationSubscription</code> in the tests.</p>
</li>
<li>
<p><strong>Condition Hit Coverage</strong>: Measures the percentage of conditions evaluated to true or false during the tests. The number of conditions times two is compared with the number of positively and negatively evaluated conditions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Maven plugin can be added to Maven by adding the following configuration to the <code>pom.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;io.sapl&lt;/groupId&gt;
    &lt;artifactId&gt;sapl-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
        &lt;policyHitRatio&gt;100&lt;/policyHitRatio&gt;
        &lt;policyConditionHitRatio&gt;50&lt;/policyConditionHitRatio&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;coverage&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;enable-coverage-collection&lt;/goal&gt;
                &lt;goal&gt;report-coverage-information&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;

    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin can be configured via the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>coverageEnabled</strong>: When set to false, this parameter disables the execution of the sapl-maven-plugin (defaultValue = true).</p>
</li>
<li>
<p><strong>policyPath</strong>: Defines the path in the classpath to the folder containing the policies under test. Specify the same path used in the <code>SaplIntegrationTestFixture</code> or the parent folder of the path to the SAPL documents in the <code>SaplUnitTestFixture</code> (defaultValue = policies).</p>
</li>
<li>
<p><strong>outputDir</strong>: Set this parameter to the path where generated reports should be written (per default, the Maven build output directory is used).</p>
</li>
<li>
<p><strong>policySetHitRatio</strong>: A value between 0 - 100 to define the ratio of PolicySets the tests should cover. If this ratio isn&#8217;t fulfilled, the sapl-maven-plugin is going to stop the Maven lifecycle. (defaultValue = 0)</p>
</li>
<li>
<p><strong>policyHitRatio</strong>: A value between 0 - 100 to define the ratio of Policies the tests should cover. If this ratio isn&#8217;t fulfilled, the sapl-maven-plugin is going to stop the Maven lifecycle (defaultValue = 0).</p>
</li>
<li>
<p><strong>policyConditionHitRatio</strong>: A value between 0 - 100 to define the ratio of condition results the tests should cover. If this ratio isn&#8217;t fulfilled, the sapl-maven-plugin is going to stop the Maven lifecycle (defaultValue = 0).</p>
</li>
<li>
<p><strong>enableSonarReport</strong>: When set to true, a coverage report with the <a href="https://monteverdi.informatik.uni-freiburg.de/sonar/documentation/analysis/generic-test/">Sonarqube Generic Coverage Format</a> is generated. This format is currently not useable as SonarQube does not import generic coverage data for languages unknown to SonarQube. Currently, there is no SonarQube Language plugin for SAPL (defaultValue = false).</p>
</li>
<li>
<p><strong>enableHtmlReport</strong>: When set to true a HTML coverage report is created. This report is similar to JaCoCo reports showing colorized line coverage and the number of covered branches for conditions in a line. The path to the <code>index.html</code> on the filesystem is printed in the Maven log. Terminals like Powershell allow clicking on these paths and opening the report directly in the browser (defaultValue = true).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-12-01 20:49:37 +0100
</div>
</div>
</body>
</html>